<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
                  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">

    <!--
         See http://wiki.openmrs.org/display/docs/Module+liquibase+File for
         documentation on this file.

         See http://www.liquibase.org/manual/home#available_database_refactorings
         for a list of supported elements and attributes
     -->
    <property name="clob.type" value="longtext"/>

    <changeSet id="html5form-2013-06-11-12:30" author="ThoughtWorks">
        <comment>
            Table for tags
        </comment>
        <createTable tableName="html5forms_tag">
            <column name="html5forms_tag_id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)"/>
        </createTable>
    </changeSet>

    <changeSet id="html5form-2013-06-12-05:30" author="ThoughtWorks">
        <comment>
            Table for tags to form mapping
        </comment>
        <createTable tableName="html5forms_form_tag_mapping">
            <column name="form_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="tag_id" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="form_id,tag_id" constraintName="html5forms_form_tag_mapping_form_id_pk"
                       tableName="html5forms_form_tag_mapping"/>
    </changeSet>

    <changeSet id="html5form-2013-06-13-07:15" author="ThoughtWorks">
        <comment>
            Table for forms
        </comment>
        <createTable tableName="html5forms_form">
            <column name="form_id" type="int">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="form_id" constraintName="html5forms_form_id_pk" tableName="html5forms_form"/>
    </changeSet>

    <changeSet id="html5form-2013-06-25-18:15" author="ThoughtWorks">
        <comment>
            adding new columns to html5forms
        </comment>
        <addColumn tableName="html5forms_form">
            <column name="model" type="text"></column>
        </addColumn>
        <addColumn tableName="html5forms_form">
            <column name="form" type="text"></column>
        </addColumn>
    </changeSet>

    <changeSet id="html5form-2013-07-1-18:15" author="ThoughtWorks">
        <comment>
            removing columns
        </comment>
        <dropColumn columnName="form"
                    tableName="html5forms_form"/>
        <dropColumn columnName="model"
                    tableName="html5forms_form"/>
    </changeSet>

    <changeSet id="html5form-2013-07-1-20:15" author="ThoughtWorks">
        <comment>
            adding new columns to html5forms
        </comment>
        <addColumn tableName="html5forms_form">
            <column name="model" type="${clob.type}"></column>
        </addColumn>
        <addColumn tableName="html5forms_form">
            <column name="form" type="${clob.type}"></column>
        </addColumn>
    </changeSet>

    <changeSet id="muzimaform-2013-07-10-12:00" author="ThoughtWorks">
        <comment>
            renames tables - prefix html5 to muzima
        </comment>

        <renameTable oldTableName="html5forms_form" newTableName="muzimaforms_form"/>
        <renameTable oldTableName="html5forms_tag" newTableName="muzimaforms_tag"/>
        <renameTable oldTableName="html5forms_form_tag_mapping" newTableName="muzimaforms_tag_map"/>

    </changeSet>

    <changeSet id="muzimaform-2013-07-10-16:30" author="ThoughtWorks">
        <comment>
            renaming old columns and adding new column to html5forms
        </comment>

        <renameColumn tableName="muzimaforms_tag" oldColumnName="html5forms_tag_id" newColumnName="muzimaforms_tag_id"
                      columnDataType="int"/>
        <renameColumn tableName="muzimaforms_form" oldColumnName="model" newColumnName="model_xml"
                      columnDataType="${clob.type}"/>
        <renameColumn tableName="muzimaforms_form" oldColumnName="form" newColumnName="form_html"
                      columnDataType="${clob.type}"/>
        <addColumn tableName="muzimaforms_form">
            <column name="model_json" type="${clob.type}"></column>
        </addColumn>
    </changeSet>

    <changeSet id="muzimaform-2013-07-10-18:00" author="ThoughtWorks">
        <comment>
            renaming columns removed autoincrement - fixing that
        </comment>
        <dropColumn tableName="muzimaforms_tag" columnName="muzimaforms_tag_id"/>
    </changeSet>

    <changeSet id="muzimaform-2013-07-10-18:30" author="ThoughtWorks">
        <comment>
            renaming columns removed autoincrement - fixing that
        </comment>
        <addColumn tableName="muzimaforms_tag">
            <column name="muzimaforms_tag_id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
        </addColumn>

    </changeSet>

    <changeSet id="muzimaform-2013-07-10-19:00" author="ThoughtWorks">
        <comment>
            adding unique constraint
        </comment>
        <addUniqueConstraint constraintName="unique-tag-name" tableName="muzimaforms_tag" columnNames="name"/>
    </changeSet>

    <changeSet id="muzimaform-2013-07-10-20:00" author="ThoughtWorks">
        <comment>
            adding audit columns
        </comment>
        <addColumn tableName="muzimaforms_form">
            <column name="creator" valueNumeric="1" type="int"/>
            <column name="date_created" valueDate="2007-05-04" type="date"/>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="date"/>
            <column name="retired" valueBoolean="false" type="boolean"/>
            <column name="retired_by" type="int"/>
            <column name="date_retired" type="date"/>
            <column name="retire_reason" type="text"/>
        </addColumn>

        <addColumn tableName="muzimaforms_tag">
            <column name="creator" valueNumeric="1" type="int"/>
            <column name="date_created" valueDate="2007-05-04" type="date"/>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="date"/>
            <column name="retired" valueBoolean="false" type="boolean"/>
            <column name="retired_by" type="int"/>
            <column name="date_retired" type="date"/>
            <column name="retire_reason" type="text"/>
        </addColumn>

        <addColumn tableName="muzimaforms_tag_map">
            <column name="creator" valueNumeric="1" type="int"/>
            <column name="date_created" valueDate="2007-05-04" type="date"/>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="date"/>
            <column name="retired" valueBoolean="false" type="boolean"/>
            <column name="retired_by" type="int"/>
            <column name="date_retired" type="date"/>
            <column name="retire_reason" type="text"/>
        </addColumn>
    </changeSet>

    <changeSet id="muzimaform-2013-07-15-16:30" author="ThoughtWorks">
        <comment>
            adding unique constraint
        </comment>
        <addColumn tableName="muzimaforms_form">
            <column name="uuid" type="char(38)"/>
        </addColumn>

        <addColumn tableName="muzimaforms_tag">
            <column name="uuid" type="char(38)"/>
        </addColumn>
        <addUniqueConstraint constraintName="unique-muzimaforms-form-uuid" tableName="muzimaforms_form"
                             columnNames="uuid"/>
        <addUniqueConstraint constraintName="unique-muzimaforms-tag-uuid" tableName="muzimaforms_tag"
                             columnNames="uuid"/>
    </changeSet>

    <changeSet id="muzimaform-2013-08-20-16:40" author="ThoughtWorks">
        <comment>
            Adding the name and description columns
        </comment>
        <addColumn tableName="muzimaforms_form">
            <column name="name" type="varchar(255)"/>
        </addColumn>
        <addColumn tableName="muzimaforms_form">
            <column name="description" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="muzimaform-2013-08-20-17:08" author="ThoughtWorks" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzimaforms_form" columnName="name"/>
                <columnExists tableName="muzimaforms_form" columnName="description"/>
            </and>
        </preConditions>
        <comment>
            Migrating already imported form names and descriptions
        </comment>
        <sql>
            UPDATE
            muzimaforms_form mform
            JOIN form form ON mform.form_id = form.form_id
            SET
            mform.name = form.name,
            mform.description = form.description
        </sql>
    </changeSet>

    <changeSet id="muzimaform-2013-12-01-09:30" author="ThoughtWorks">
        <comment>
            Adding default values for boolean columns in muzimaforms_form related tables
        </comment>
        <addDefaultValue tableName="muzimaforms_form" columnName="retired" defaultValueBoolean="false"/>
        <addDefaultValue tableName="muzimaforms_tag" columnName="retired" defaultValueBoolean="false"/>
        <addDefaultValue tableName="muzimaforms_tag_map" columnName="retired" defaultValueBoolean="false"/>
    </changeSet>

    <changeSet id="muzimaform-2013-12-02-09:30" author="ThoughtWorks">
        <comment>
            Adding default values for the existing records in muzimaforms_form related tables
        </comment>
        <update tableName="muzimaforms_form">
            <column name="retired" valueBoolean="false"/>
            <where>
                retired is null
            </where>
        </update>
        <update tableName="muzimaforms_tag">
            <column name="retired" valueBoolean="false"/>
            <where>
                retired is null
            </where>
        </update>
        <update tableName="muzimaforms_tag_map">
            <column name="retired" valueBoolean="false"/>
            <where>
                retired is null
            </where>
        </update>
    </changeSet>

    <changeSet id="muzimaform-2014-06-29-22:55" author="nribeka" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzimaforms_form" columnName="discriminator"/>
            </not>
        </preConditions>
        <comment>
            Adding the discriminator column
        </comment>
        <addColumn tableName="muzimaforms_form">
            <column name="discriminator" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="muzimaform-2014-07-14-21:36" author="nribeka" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzimaforms_form" columnName="form"/>
            </not>
        </preConditions>
        <comment>
            Adding the form relation to resolve the encounter type.
        </comment>
        <addColumn tableName="muzimaforms_form">
            <column name="form" type="char(38)"/>
        </addColumn>
    </changeSet>

    <changeSet id="muzimaform-2014-10-16" author="SahajSoft">
        <comment>
            Adding version column
        </comment>
        <addColumn tableName="muzimaforms_form">
            <column name="version" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="muzimaform-2014-10-31" author="SahajSoft">
        <addForeignKeyConstraint baseColumnNames="form"
                                 baseTableName="muzimaforms_form"
                                 constraintName="fk_muzimaforms_form_openmrs_form"
                                 referencedColumnNames="uuid"
                                 referencedTableName="form"/>
    </changeSet>

    <changeSet author="shwetha" id="muzimaform-2014-10-17" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzimaforms_form" columnName="name"/>
                <columnExists tableName="muzimaforms_form" columnName="description"/>
                <columnExists tableName="muzimaforms_form" columnName="version"/>
            </and>
        </preConditions>
        <dropColumn columnName="name"
                    tableName="muzimaforms_form"/>
        <dropColumn columnName="description"
                    tableName="muzimaforms_form"/>
        <dropColumn columnName="version"
                    tableName="muzimaforms_form"/>
    </changeSet>

    <changeSet id="muzima-2013-04-18-10-50" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_data_source"/>
            </not>
        </preConditions>
        <createTable tableName="muzima_data_source">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(1024)"/>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="retired" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="retired_by" type="int"/>
            <column name="date_retired" type="datetime"/>
            <column name="retire_reason" type="varchar(255)" defaultValue="null"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzima_data_source_creator"
                                 baseTableName="muzima_data_source" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_data_source_changed_by"
                                 baseTableName="muzima_data_source" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_data_source_retired_by"
                                 baseTableName="muzima_data_source" baseColumnNames="retired_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
    </changeSet>

    <changeSet id="muzima-2013-04-18-10-51" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_queue_data"/>
            </not>
        </preConditions>
        <createTable tableName="muzima_queue_data">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="discriminator" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="data_source" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="mediumtext">
                <constraints nullable="false"/>
            </column>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzima_queue_data_creator"
                                 baseTableName="muzima_queue_data" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_queue_data_changed_by"
                                 baseTableName="muzima_queue_data" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_queue_data_data_source"
                                 baseTableName="muzima_queue_data" baseColumnNames="data_source"
                                 referencedTableName="muzima_data_source" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="muzima-2013-04-18-10-52" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_archive_data"/>
            </not>
        </preConditions>
        <createTable tableName="muzima_archive_data">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="discriminator" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="data_source" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="mediumtext">
                <constraints nullable="false"/>
            </column>
            <column name="message" type="varchar(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="date_archived" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzima_archive_data_creator"
                                 baseTableName="muzima_archive_data" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_archive_data_changed_by"
                                 baseTableName="muzima_archive_data" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_archive_data_data_source"
                                 baseTableName="muzima_archive_data" baseColumnNames="data_source"
                                 referencedTableName="muzima_data_source" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="muzima-2013-04-18-10-53" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_error_data"/>
            </not>
        </preConditions>
        <createTable tableName="muzima_error_data">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="discriminator" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="data_source" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="mediumtext">
                <constraints nullable="false"/>
            </column>
            <column name="message" type="varchar(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="date_processed" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzima_error_data_creator"
                                 baseTableName="muzima_error_data" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_error_data_changed_by"
                                 baseTableName="muzima_error_data" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_error_data_data_source"
                                 baseTableName="muzima_error_data" baseColumnNames="data_source"
                                 referencedTableName="muzima_data_source" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="muzima-2013-04-18-10-54" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_notification_data"/>
            </not>
        </preConditions>
        <createTable tableName="muzima_notification_data">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="subject" type="varchar(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="varchar(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="receiver" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="sender" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="voided" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="voided_by" type="int"/>
            <column name="date_voided" type="datetime"/>
            <column name="void_reason" type="varchar(255)" defaultValue="null"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzima_notification_data_creator"
                                 baseTableName="muzima_notification_data" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_notification_data_changed_by"
                                 baseTableName="muzima_notification_data" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_notification_data_voided_by"
                                 baseTableName="muzima_notification_data" baseColumnNames="voided_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_notification_data_sender"
                                 baseTableName="muzima_notification_data" baseColumnNames="sender"
                                 referencedTableName="person" referencedColumnNames="person_id"/>
        <addForeignKeyConstraint constraintName="muzima_notification_data_receiver"
                                 baseTableName="muzima_notification_data" baseColumnNames="receiver"
                                 referencedTableName="person" referencedColumnNames="person_id"/>
    </changeSet>

    <changeSet id="nribeka" author="muzima-2014-02-04-07-10-54">
        <preConditions onFail="MARK_RAN">
            <and>
                <not>
                    <columnExists tableName="muzima_notification_data" columnName="status"/>
                </not>
                <not>
                    <columnExists tableName="muzima_notification_data" columnName="source"/>
                </not>
            </and>
        </preConditions>
        <addColumn tableName="muzima_notification_data">
            <column name="status" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
            <column name="source" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="muzima-20140312-110700" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <changeSetExecuted id="nribeka" author="muzima-2014-02-04-07-10-54" changeLogFile="liquibase.xml"/>
        </preConditions>
        <delete tableName="liquibasechangelog">
            <where>id='nribeka' and author='muzima-2014-02-04-07-10-54'</where>
        </delete>
    </changeSet>

    <changeSet id="muzima-20140312-110800" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzima_notification_data" columnName="status"/>
                <columnExists tableName="muzima_notification_data" columnName="source"/>
            </and>
        </preConditions>
        <dropColumn tableName="muzima_notification_data" columnName="status"/>
        <dropColumn tableName="muzima_notification_data" columnName="source"/>
    </changeSet>

    <changeSet id="muzima-20140312-110900" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <and>
                <not>
                    <columnExists tableName="muzima_notification_data" columnName="status"/>
                </not>
                <not>
                    <columnExists tableName="muzima_notification_data" columnName="source"/>
                </not>
            </and>
        </preConditions>
        <addColumn tableName="muzima_notification_data">
            <column name="status" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
            <column name="source" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-20140312-111000" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_notification_data" columnName="role"/>
            </not>
        </preConditions>
        <addColumn tableName="muzima_notification_data">
            <column name="role" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="muzima_notification_data_role"
                                 baseTableName="muzima_notification_data" baseColumnNames="role"
                                 referencedTableName="role" referencedColumnNames="role"/>
    </changeSet>

    <changeSet id="muzima-20140312-111100" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="muzima_notification_data" columnName="receiver"/>
        </preConditions>
        <dropNotNullConstraint tableName="muzima_notification_data" columnName="receiver" columnDataType="int"/>
    </changeSet>

    <changeSet id="muzima-2015-03-30-4:00pm" author="Vikas">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_error_message"/>
            </not>
        </preConditions>
        <createTable tableName="muzima_error_message">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="muzima_error_data_id" type="int">
            </column>
            <column name="message" type="varchar(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzima_error_message_creator"
                                 baseTableName="muzima_error_message" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_error_message_changed_by"
                                 baseTableName="muzima_error_message" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_error_message_data"
                                 baseTableName="muzima_error_message" baseColumnNames="muzima_error_data_id"
                                 referencedTableName="muzima_error_data" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="muzima-20150819-111000" author="shwetha">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_queue_data" columnName="location_id"/>
            </not>
        </preConditions>
        <addColumn tableName="muzima_queue_data">
            <column name="location_id" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addColumn tableName="muzima_queue_data">
            <column name="location_name" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addColumn tableName="muzima_queue_data">
            <column name="provider_id" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addColumn tableName="muzima_queue_data">
            <column name="provider_name" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-20150820-112000" author="shwetha">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_error_data" columnName="location_id"/>
            </not>
        </preConditions>
        <addColumn tableName="muzima_error_data">
            <column name="location_id" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addColumn tableName="muzima_error_data">
            <column name="location_name" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addColumn tableName="muzima_error_data">
            <column name="provider_id" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addColumn tableName="muzima_error_data">
            <column name="provider_name" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-20150825-113000" author="shwetha">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_queue_data" columnName="form_name"/>
            </not>
        </preConditions>
        <addColumn tableName="muzima_queue_data">
            <column name="form_name" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-20150825-114000" author="shwetha">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_error_data" columnName="form_name"/>
            </not>
        </preConditions>
        <addColumn tableName="muzima_error_data">
            <column name="form_name" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-20150909-113000" author="shwetha">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzima_queue_data" columnName="location_id"/>
                <columnExists tableName="muzima_queue_data" columnName="location_name"/>
            </and>
        </preConditions>
        <dropColumn tableName="muzima_queue_data" columnName="location_id"/>
        <dropColumn tableName="muzima_queue_data" columnName="location_name"/>
        <addColumn tableName="muzima_queue_data">
            <column name="location" type="int">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="muzima_queue_data_location"
                                 baseTableName="muzima_queue_data" baseColumnNames="location"
                                 referencedTableName="location" referencedColumnNames="location_id"/>
    </changeSet>

    <changeSet id="muzima-20150909-114000" author="shwetha">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzima_error_data" columnName="location_id"/>
                <columnExists tableName="muzima_error_data" columnName="location_name"/>
            </and>
        </preConditions>
        <dropColumn tableName="muzima_error_data" columnName="location_id"/>
        <dropColumn tableName="muzima_error_data" columnName="location_name"/>
        <addColumn tableName="muzima_error_data">
            <column name="location" type="int">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="muzima_error_data_location"
                                 baseTableName="muzima_error_data" baseColumnNames="location"
                                 referencedTableName="location" referencedColumnNames="location_id"/>
    </changeSet>

    <changeSet id="muzima-20150910-113000" author="shwetha">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzima_queue_data" columnName="provider_id"/>
                <columnExists tableName="muzima_queue_data" columnName="provider_name"/>
            </and>
        </preConditions>
        <dropColumn tableName="muzima_queue_data" columnName="provider_id"/>
        <dropColumn tableName="muzima_queue_data" columnName="provider_name"/>
        <addColumn tableName="muzima_queue_data">
            <column name="provider" type="int">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="muzima_queue_data_provider"
                                 baseTableName="muzima_queue_data" baseColumnNames="provider"
                                 referencedTableName="provider" referencedColumnNames="provider_id"/>
    </changeSet>

    <changeSet id="muzima-20150910-114000" author="shwetha">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzima_error_data" columnName="provider_id"/>
                <columnExists tableName="muzima_error_data" columnName="provider_name"/>
            </and>
        </preConditions>
        <dropColumn tableName="muzima_error_data" columnName="provider_id"/>
        <dropColumn tableName="muzima_error_data" columnName="provider_name"/>
        <addColumn tableName="muzima_error_data">
            <column name="provider" type="int">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="muzima_error_data_provider"
                                 baseTableName="muzima_error_data" baseColumnNames="provider"
                                 referencedTableName="provider" referencedColumnNames="provider_id"/>
    </changeSet>

    <changeSet id="muzima-2015-10-05-11:45am" author="VNAGARAJAN">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_error_data" columnName="patientUuid"/>
            </not>
        </preConditions>
        <addColumn tableName="muzima_error_data">
            <column name="patientUuid" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-2015-10-05-12:00pm" author="VNAGARAJAN">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_queue_data" columnName="patientUuid"/>
            </not>
        </preConditions>
        <addColumn tableName="muzima_queue_data">
            <column name="patientUuid" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-2015-10-05-11:31am" author="VNAGARAJAN">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_archive_data" columnName="patientUuid"/>
            </not>
        </preConditions>
        <addColumn tableName="muzima_archive_data">
            <column name="patientUuid" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet author="mssavai" id="muzima-20151102-105200">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzima_error_data" columnName="patientUuid"/>
            </and>
        </preConditions>
        <renameColumn columnDataType="varchar(255)"
                      newColumnName="patient_uuid"
                      oldColumnName="patientUuid"
                      tableName="muzima_error_data"/>
    </changeSet>
    <changeSet author="mssavai" id="muzima-20151102-105300">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzima_queue_data" columnName="patientUuid"/>
            </and>
        </preConditions>
        <renameColumn columnDataType="varchar(255)"
                      newColumnName="patient_uuid"
                      oldColumnName="patientUuid"
                      tableName="muzima_queue_data"/>
    </changeSet>
    <changeSet author="mssavai" id="muzima-20151102-105400">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzima_archive_data" columnName="patientUuid"/>
            </and>
        </preConditions>
        <renameColumn columnDataType="varchar(255)"
                      newColumnName="patient_uuid"
                      oldColumnName="patientUuid"
                      tableName="muzima_archive_data"/>
    </changeSet>

    <changeSet id="smbugua" author="muzima-2015-10-15-20-13-12">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_notification_data" columnName="patient"/>
            </not>
        </preConditions>
        <addColumn tableName="muzima_notification_data">
            <column name="patient" type="int">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="muzima_notification_patient"
                                 baseTableName="muzima_notification_data" baseColumnNames="patient"
                                 referencedTableName="patient" referencedColumnNames="patient_id"/>
    </changeSet>

    <changeSet id="muzimaregistration-2013-06-18-09-20" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzimaregistration_registration_data"/>
            </not>
        </preConditions>
        <createTable tableName="muzimaregistration_registration_data">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="temporary_uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="assigned_uuid" type="char(38)">
                <constraints nullable="false"/>
            </column>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>

            <column name="voided" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="voided_by" type="int"/>
            <column name="date_voided" type="datetime"/>
            <column name="void_reason" type="varchar(255)" defaultValue="null"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzimaregistration_registration_data_creator"
                                 baseTableName="muzimaregistration_registration_data" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzimaregistration_registration_data_changed_by"
                                 baseTableName="muzimaregistration_registration_data" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzimaregistration_registration_data_voided_by"
                                 baseTableName="muzimaregistration_registration_data" baseColumnNames="voided_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
    </changeSet>

    <changeSet id="muzima-20160901-093538" author="smbugua">
        <comment>
            Renames tables - prefix muzimaform to muzima and rename columns and constraints appropriately
        </comment>

        <!--First drop the existing constraints on these tables-->
        <dropForeignKeyConstraint baseTableName="muzimaforms_form" constraintName="fk_muzimaforms_form_openmrs_form"/>
        <dropUniqueConstraint tableName="muzimaforms_form" constraintName="unique-muzimaforms-form-uuid"/>
        <dropUniqueConstraint tableName="muzimaforms_tag" constraintName="unique-muzimaforms-tag-uuid"/>
        <dropUniqueConstraint tableName="muzimaforms_tag" constraintName="unique-tag-name"/>

        <!--Then rename the tables-->
        <renameTable oldTableName="muzimaforms_form" newTableName="muzima_form"/>
        <renameTable oldTableName="muzimaforms_tag" newTableName="muzima_form_tag"/>
        <renameTable oldTableName="muzimaforms_tag_map" newTableName="muzima_form_tag_map"/>

        <!--Finally add the new constraints-->
        <addForeignKeyConstraint constraintName="muzima_form_openmrs_form" baseTableName="muzima_form" baseColumnNames="form"
                                 referencedTableName="form" referencedColumnNames="uuid"/>
        <addUniqueConstraint constraintName="unique-muzima-form-uuid" tableName="muzima_form" columnNames="uuid"/>
        <addUniqueConstraint constraintName="unique-muzima-form-tag-uuid" tableName="muzima_form_tag" columnNames="uuid"/>
        <addUniqueConstraint constraintName="unique-muzima-form-tag-name" tableName="muzima_form_tag" columnNames="name"/>
    </changeSet>

    <changeSet id="muzima-20160901-094022" author="smbugua">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="muzimaregistration_registration_data"/>
                <not>
                    <tableExists tableName="muzima_registration_data"/>
                </not>
            </and>
        </preConditions>

        <comment>
            Renames tables and indices - prefix muzimaregistration to muzima
        </comment>

        <!--First drop the existing constraints on this table-->
        <dropForeignKeyConstraint baseTableName="muzimaregistration_registration_data" constraintName="muzimaregistration_registration_data_creator"/>
        <dropForeignKeyConstraint baseTableName="muzimaregistration_registration_data" constraintName="muzimaregistration_registration_data_changed_by"/>
        <dropForeignKeyConstraint baseTableName="muzimaregistration_registration_data" constraintName="muzimaregistration_registration_data_voided_by"/>

        <!--Then rename the table-->
        <renameTable oldTableName="muzimaregistration_registration_data" newTableName="muzima_registration_data"/>

        <!--Finally add the new constraints-->
        <addForeignKeyConstraint constraintName="muzima_registration_data_creator" baseTableName="muzima_registration_data" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_registration_data_changed_by" baseTableName="muzima_registration_data" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_registration_data_voided_by" baseTableName="muzima_registration_data" baseColumnNames="voided_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
    </changeSet>

    <changeSet id="muzima-20160901-115152" author="smbugua">
        <comment>
            Rename primary key in table muzima_form_tag using raw sql since renameColumn loses autoIncrement feature
        </comment>
        <sql>
            ALTER TABLE `muzima_form_tag`
            CHANGE COLUMN `muzimaforms_tag_id` `muzima_form_tag_id`  int NOT NULL AUTO_INCREMENT FIRST
        </sql>
    </changeSet>

    <changeSet id="muzima-20160915154129" author="smbugua">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_config"/>
            </not>
        </preConditions>
        <createTable tableName="muzima_config">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(1024)"/>
            <column name="config_json" type="${clob.type}"/>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="retired" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="retired_by" type="int"/>
            <column name="date_retired" type="datetime"/>
            <column name="retire_reason" type="varchar(255)" defaultValue="null"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzima_config_creator"
                                 baseTableName="muzima_config" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_config_changed_by"
                                 baseTableName="muzima_config" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_config_retired_by"
                                 baseTableName="muzima_config" baseColumnNames="retired_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
    </changeSet>

    <changeSet id="muzima-20160922-145252" author="smbugua">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_form" columnName="meta_json"/>
            </not>
        </preConditions>

        <comment>
            Add column metadata to store metadata as a json blob
        </comment>

        <addColumn tableName="muzima_form">
            <column name="meta_json" type="${clob.type}"/>
        </addColumn>
    </changeSet>
    <changeSet id="muzima-20170912151100" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_setting"/>
            </not>
        </preConditions>
        <createTable tableName="muzima_setting">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="property" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="name" type="varchar(255)"/>
            <column name="description" type="varchar(1024)"/>
            <column name="value_boolean" type="tinyint"/>
            <column name="value_string" type="varchar(255)"/>
            <column name="setting_data_type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="retired" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="retired_by" type="int"/>
            <column name="date_retired" type="datetime"/>
            <column name="retire_reason" type="varchar(255)" defaultValue="null"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzima_setting_creator"
                                 baseTableName="muzima_setting" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_setting_changed_by"
                                 baseTableName="muzima_setting" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_setting_retired_by"
                                 baseTableName="muzima_setting" baseColumnNames="retired_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
    </changeSet>

    <changeSet id="muzima-20170922145600" author="mssavai">
        <insert tableName="muzima_setting">
            <column name="property" value="PatientIdentifier.AutoGeneration" />
            <column name="name" value="Patient Identifier auto-generation" />
            <column name="description" value="Defines whether or not patient patient identifier should be autogenerated during processing mUzima registration data. This should be set to 'true' if autogeneration is needed" />
            <column name="setting_data_type" value="BOOLEAN" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2017-09-22T00:00:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="2a277ceb-7f23-4cc0-9e9b-1686985df121" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20171017151600" author="mssavai">
        <insert tableName="muzima_setting">
            <column name="property" value="PatientIdentifier.AutoGenerationSourceName" />
            <column name="name" value="Patient Identifier auto-generation Source name" />
            <column name="description" value="Specifies name of auto-generation source defined in ID-GEN module" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2017-10-17T00:00:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="aae1a60f-f6ac-4d00-8af7-80270d715114" />
        </insert>
    </changeSet>
   <changeSet id="muzima-20180620158900" author="dileka">
       <preConditions onFail="MARK_RAN">
           <sqlCheck expectedResult="0">
               SELECT COUNT(*) FROM muzima_setting where property = 'PatientCohort.AutoDownload'
           </sqlCheck>
       </preConditions>
        <insert tableName="muzima_setting">
            <column name="property" value="PatientCohort.AutoDownload" />
            <column name="name" value="Patient Cohort auto-download" />
            <column name="description" value="Defines whether cohorts are downloaded automatically to muzima" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="true" />
            <column name="date_created" valueDate="2018-06-20T00:00:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="aae1a60f-f6ac-4d00-ffff-80270d715114" />
        </insert>
    </changeSet>
    <changeSet id="muzima-20180214100000" author="bmokaya">
        <comment>Creating a default mUzima data source with the name Mobile Devices</comment>
        <insert tableName="muzima_data_source">
            <column name="name" value="Mobile Devices"/>
            <column name="description" value="Default data source"/>
            <column name="creator" value="1"/>
            <column name="date_created" valueDate="2018-02-14T10:00:00"/>
            <column name="uuid" value="0d62b128-010e-4c1b-ba86-ef963b7f8a72"/>
        </insert>
    </changeSet>

    <changeSet id="muzima-20180621154129" author="dileka">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_cohort_report_config"/>
            </not>
            <and>
                <tableExists tableName="reporting_report_design"/>
            </and>

        </preConditions>
        <createTable tableName="muzima_cohort_report_config">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cohort_uuid" type="char(38)">
                <constraints nullable="false"/>
            </column>
            <column name="report_design_uuid" type="char(38)">
                <constraints nullable="false"/>

            </column>
            <column name="priority" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>

            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int" />
            <column name="date_changed" type="datetime"/>
            <column name="retired" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="retired_by" type="int"/>
            <column name="date_retired" type="datetime"/>
            <column name="retire_reason" type="varchar(255)" defaultValue="null"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzima_cohort_report_config_creator"
                                 baseTableName="muzima_cohort_report_config" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_cohort_report_config_changed_by"
                                 baseTableName="muzima_cohort_report_config" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_cohort_report_config_retired_by"
                                 baseTableName="muzima_cohort_report_config" baseColumnNames="retired_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
    </changeSet>

    <changeSet id="muzima-20180630154129" author="dileka">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_generated_report"/>
            </not>
        </preConditions>
        <createTable tableName="muzima_generated_report">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cohort_report_config_id" type="int">
            </column>

            <column name="report_request_uuid" type="char(38)">
                <constraints nullable="false"/>
            </column>

            <column name="status" type="varchar(255)"/>

            <column name="patient_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="report_json" type="longblob">

            </column>
            <column name="priority" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>

            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int" />
            <column name="date_changed" type="datetime"/>
            <column name="retired" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="retired_by" type="int"/>
            <column name="date_retired" type="datetime"/>
            <column name="retire_reason" type="varchar(255)" defaultValue="null"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="muzima-20180626154129" author="dileka" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config where schedulable_class =
                'org.openmrs.module.muzima.task.GeneratePatientReportsTask'
            </sqlCheck>
        </preConditions>
        <comment>Add GeneratePatientReportsTask to scheduler</comment>
        <sql>
            INSERT INTO  scheduler_task_config  (name, description, schedulable_class,
            start_time, start_time_pattern, repeat_interval, start_on_startup, started,
            created_by, date_created, changed_by, date_changed, last_execution_time, uuid )
            VALUES ('Auto Generate Patient Reports', 'Generates patient reports for specified cohort report mappings', 'org.openmrs.module.muzima.task.GeneratePatientReportsTask',
            '2018-06-26 00:00:00','MM/dd/yyyy HH:mm:ss',86400, 1, 1,
            1, now(), NULL, NULL, NULL, uuid());
        </sql>
    </changeSet>


    <changeSet id="muzima-20180720102200" author="bmokaya">
        <dropNotNullConstraint columnDataType="int" columnName="patient" tableName="muzima_notification_data"/>
    </changeSet>

    <changeSet id="muzima-20180717115600" author="mssavai">
        <insert tableName="muzima_setting">
            <column name="property" value="AudioContentComplexObs.ConceptUuid" />
            <column name="name" value="Concept Uuid for Complex Obs Audio Content" />
            <column name="description" value="Specifies Concept Uuid for Complex Obs Audio Content" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2018-07-17T11:56:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="24caa622-691a-493b-b9ac-8ee70424ad47" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20180717120000" author="mssavai">
        <insert tableName="muzima_setting">
            <column name="property" value="VideoContentComplexObs.ConceptUuid" />
            <column name="name" value="Concept Uuid for Complex Obs Video Content" />
            <column name="description" value="Specifies Concept Uuid for Complex Obs Video Content" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2018-07-17T12:00:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="eaf882a3-3360-45b3-b480-ee9e634bc74f" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20180717120200" author="mssavai">
        <insert tableName="muzima_setting">
            <column name="property" value="ImageContentComplexObs.ConceptUuid" />
            <column name="name" value="Concept Uuid for Complex Obs Image Content" />
            <column name="description" value="Specifies Concept Uuid for Complex Obs Image Content" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2018-07-17T12:02:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="fd759595-6338-491b-ac37-62e699c1823c" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20180717120700" author="mssavai">
        <insert tableName="muzima_setting">
            <column name="property" value="FileContentComplexObs.ConceptUuid" />
            <column name="name" value="Concept Uuid for Complex Obs File Content" />
            <column name="description" value="Specifies Concept Uuid for Complex Obs File Content" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2018-07-17T12:07:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="651fc189-127f-4b4c-98f3-121ed5ad182e" />
        </insert>
    </changeSet>
    <changeSet id="expandedcohort-2015-03-19-15:50" author="msavai">
        <preConditions onFail="MARK_RAN">
            <not><tableExists tableName="expanded_cohort_definition"/></not>
        </preConditions>
        <comment>
            Creating the expanded cohort table
        </comment>
        <createTable tableName="expanded_cohort_definition">
            <column name="id" type="int"  autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cohort_id" type="int"/>
            <column name="sql_definition" type="text"/>
            <column name="is_scheduled" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="voided" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="voided_by" type="int"/>
            <column name="date_voided" type="datetime"/>
            <column name="void_reason" type="varchar(255)" defaultValue="null"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="expandedcohort-2018-07-20-13:14" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <not><tableExists tableName="expanded_cohort_update_history"/></not>
        </preConditions>
        <comment>
            Creating the expanded cohort update history table
        </comment>
        <createTable tableName="expanded_cohort_update_history">
            <column name="id" type="int"  autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cohort_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="members_added" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="date_updated" type="datetime">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="expandedcohort-2018-08-25-15:52" author="mssavai" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="expanded_cohort_update_history" columnName="members_removed"/>
            </not>
        </preConditions>
        <comment>
            Adding the members_removed column
        </comment>
        <addColumn tableName="expanded_cohort_update_history">
            <column name="members_removed" type="text"/>
        </addColumn>
    </changeSet>
    <changeSet id="expandedcohort-2018-08-25-16:35" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="expanded_cohort_update_history" columnName="members_added"/>
        </preConditions>
        <comment>
            Dropping null constraint on members_added column
        </comment>
        <dropNotNullConstraint tableName="expanded_cohort_update_history"
                               columnName="members_added"
                               columnDataType="text"/>
    </changeSet>
    <changeSet id="expandedcohort-2018-08-27-13:12" author="mssavai" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="expanded_cohort_definition" columnName="enable_member_addition"/>
            </not>
        </preConditions>
        <comment>
            Adding the enable_member_addition column
        </comment>
        <addColumn tableName="expanded_cohort_definition">
            <column name="enable_member_addition" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="expandedcohort-2018-08-27-13:16" author="mssavai" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="expanded_cohort_definition" columnName="enable_member_removal"/>
            </not>
        </preConditions>
        <comment>
            Adding the enable_member_removal column
        </comment>
        <addColumn tableName="expanded_cohort_definition">
            <column name="enable_member_removal" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-20180831113800" author="bmokaya">
        <insert tableName="muzima_setting">
            <column name="property" value="SHRStatus.isEnabled" />
            <column name="name" value="SHR status" />
            <column name="description" value="Specifies if smart card feature will be enabled on Android App" />
            <column name="setting_data_type" value="BOOLEAN" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2018-08-31T00:00:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="25e52b76-dbef-4629-aed2-5497a1f8303c" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20180831113900" author="samuelowino">
        <insert tableName="muzima_setting">
            <column name="property" value="GPSStatus.isEnabled" />
            <column name="name" value="GPS status" />
            <column name="description" value="Specifies if GPS tracking feature will be activated on mUzima mobile application" />
            <column name="setting_data_type" value="BOOLEAN" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2018-09-27T00:00:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="7c5f3458-c240-11e8-a355-529269fb145i" />
        </insert>

    </changeSet>

    <changeSet id="muzima-20190214135300" author="bmokaya">
        <insert tableName="muzima_setting">
            <column name="property" value="MediaWrapperConcept.ConceptUuid" />
            <column name="name" value="Uuid for Media Wrapper Concept" />
            <column name="description" value="Specifies Concept-Uuid for convenient set concept that wraps media complex obs with its metadata" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-02-14T13:53:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="b7c0c988-3047-11e9-873e-d0577bcb2fe6" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20190214140100" author="bmokaya">
        <insert tableName="muzima_setting">
            <column name="property" value="MediaCategoryOtherNonCoded.ConceptUuid" />
            <column name="name" value="Concept Uuid for other non-coded category" />
            <column name="description" value="Specifies Concept-Uuid for concept-set other non-coded option for media category" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-02-14T13:56:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="f81e3970-3047-11e9-873e-d0577bcb2fe6" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20190214140300" author="bmokaya">
        <insert tableName="muzima_setting">
            <column name="property" value="MediaContentComment.ConceptUuid" />
            <column name="name" value="Concept Uuid for Media Content Comment" />
            <column name="description" value="Specifies Concept-Uuid for media comment concept" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-02-14T14:03:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="235e34e6-3048-11e9-873e-d0577bcb2fe6" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20190220103000" author="bmokaya">
        <insert tableName="muzima_setting">
            <column name="property" value="MediaCategoryFreeText.ConceptUuid" />
            <column name="name" value="Concept Uuid for Other category text" />
            <column name="description" value="Specifies Concept-Uuid for free text for other-non coded category option" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-02-20T10:30:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="adbda0a4-34d5-11e9-8667-d0577bcb2fe6" />
        </insert>
    </changeSet>
    <changeSet id="muzima-20190430114100" author="smbugua">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzima_cohort_report_config" columnName="report_design_uuid"/>
            </and>
        </preConditions>
        <comment>
            changing type for report_design column in muzima_cohort_report_config table
        </comment>

        <renameColumn tableName="muzima_cohort_report_config" oldColumnName="report_design_uuid" newColumnName="report_designs"
                      columnDataType="${clob.type}"/>
    </changeSet>
    <changeSet id="muzima-20190503023107" author="smbugua">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="muzima_generated_report"/>
        </preConditions>
        <comment>
            renames tables - patient reports
        </comment>

        <renameTable oldTableName="muzima_generated_report" newTableName="muzima_patient_report"/>
    </changeSet>
    <changeSet id="muzima-20190503023643" author="smbugua">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_patient_report" columnName="name"/>
            </not>
        </preConditions>
        <comment>
            add name column to the patient reports table
        </comment>
        <addColumn tableName="muzima_patient_report">
            <column name="name" type="varchar(255)"/>
        </addColumn>
    </changeSet>
    <changeSet id="muzima-20190822212731" author="smbugua">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="muzima_setting"/>
        </preConditions>
        <comment>
            Modify muzima setting for Patient Reports
        </comment>
        <update tableName="muzima_setting">
            <column name="setting_data_type" value="BOOLEAN"/>
            <column name="property" value="PatientReport.isEnabled"/>
            <column name="name" value="Patient Report Download Status"/>
            <column name="description" value="Whether patient reports will be downloaded to mobile device"/>
            <where>uuid = 'aae1a60f-f6ac-4d00-ffff-80270d715114'</where>
        </update>
    </changeSet>

    <changeSet id="muzima-20190418094500" author="bmokaya">
        <insert tableName="muzima_setting">
            <column name="property" value="MediaTitle.ConceptUuid" />
            <column name="name" value="Concept Uuid for the title of the media" />
            <column name="description" value="Specifies Concept-Uuid for the title of the media uploaded" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-04-18T09:45:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="0080ecb8-61a6-11e9-a5ac-d0577bcb2fe6" />
        </insert>
    </changeSet>
    <changeSet id="muzima-201909041456" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_queue_data" columnName="form_data_uuid"/>
            </not>
        </preConditions>
        <comment>
            Adding the form_data_uuid column to muzima_queue_data table
        </comment>
        <addColumn tableName="muzima_queue_data">
            <column name="form_data_uuid" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-201909041500" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_error_data" columnName="form_data_uuid"/>
            </not>
        </preConditions>
        <comment>
            Adding the form_data_uuid column to muzima_error_data table
        </comment>
        <addColumn tableName="muzima_error_data">
            <column name="form_data_uuid" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-201909041505" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_archive_data" columnName="form_data_uuid"/>
            </not>
        </preConditions>
        <comment>
            Adding the form_data_uuid column to muzima_archive_data table
        </comment>
        <addColumn tableName="muzima_archive_data">
            <column name="form_data_uuid" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-20190829172700" author="smbugua">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_setting where uuid = 'f8c4ea54-9e8f-4f47-86c1-ab52f0bc719f';
            </sqlCheck>
        </preConditions>
        <comment>Add Relationships Setting</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="Relationships.isEnabled"/>
            <column name="name" value="Relationships status" />
            <column name="description" value="Specifies if Relationships feature will be enabled for this implementation" />
            <column name="setting_data_type" value="BOOLEAN" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-08-29T17:27:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="f8c4ea54-9e8f-4f47-86c1-ab52f0bc719f" />
        </insert>

    </changeSet>

    <changeSet id="muzima-20191117190900" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_setting where uuid = 'f268a5cf-5583-4e8a-9704-20f638732021';
            </sqlCheck>
        </preConditions>
        <comment>Add Event Logging Setting</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="Logging.isEnabled"/>
            <column name="name" value="Event Logging status" />
            <column name="description" value="Specifies whether Event Logging feature will be enabled for this implementation" />
            <column name="setting_data_type" value="BOOLEAN" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-11-17T19:09:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="f268a5cf-5583-4e8a-9704-20f638732021" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20191117191200" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_setting where uuid = '5e75dd1e-ae43-4e3c-8860-bb7fcc1d79ff';
            </sqlCheck>
        </preConditions>
        <comment>Add Event Logs server URL Setting</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="LogServer.url"/>
            <column name="name" value="Event Logs server URL" />
            <column name="description" value="Specifies the URL of the Server where event logs should be transmitted" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-11-17T19:12:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="5e75dd1e-ae43-4e3c-8860-bb7fcc1d79ff" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20191117191800" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_setting where uuid = '6babf927-e531-4119-8369-2981133d836c';
            </sqlCheck>
        </preConditions>
        <comment>Add Event Logs server Connection key Setting</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="LogServer.connectionKey"/>
            <column name="name" value="Event Logs server Connection Key" />
            <column name="description" value="Specifies the Connection Key for use while transmitting logs to the Logs server" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-11-17T19:18:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="6babf927-e531-4119-8369-2981133d836c" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20191203163000" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_setting where uuid = '35a658af-cdfa-4ac4-ac35-a1e40e1def0d';
            </sqlCheck>
        </preConditions>
        <comment>Add Setting for enabling Geomapping feature</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="LoggingDeidentification.isEnabled"/>
            <column name="name" value="Logging Deidentification status" />
            <column name="description" value="Specifies whether Deidentification of logging information will be done for this implementation" />
            <column name="setting_data_type" value="BOOLEAN" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-12-03T16:30:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="35a658af-cdfa-4ac4-ac35-a1e40e1def0d" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20191203155800" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_setting where uuid = '3933439b-cc1e-46a8-abb2-6d3587d1baf0';
            </sqlCheck>
        </preConditions>
        <comment>Add Setting for enabling Geomapping feature</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="GeoMapping.isEnabled"/>
            <column name="name" value="Geomapping feature status" />
            <column name="description" value="Specifies whether Geomapping feature will be enabled for this implementation" />
            <column name="setting_data_type" value="BOOLEAN" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-12-03T15:58:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="3933439b-cc1e-46a8-abb2-6d3587d1baf0" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20191203164100" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_setting where uuid = '0309dfba-a66b-4b03-a10b-5ca8ed37ff70';
            </sqlCheck>
        </preConditions>
        <comment>Add maps key setting</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="MapsApi.key"/>
            <column name="name" value="Maps API Key" />
            <column name="description" value="Specifies the Key for accessing maps services" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-12-03T16:41:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="0309dfba-a66b-4b03-a10b-5ca8ed37ff70" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20191128132500" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_setting where uuid = 'eb780e26-30a0-4e53-b3da-a3f56f13ccde';
            </sqlCheck>
        </preConditions>
        <comment>Add Event Logs server Connection key Setting</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="Encounter.maxDownloadSize"/>
            <column name="name" value="Maximum number of Encounters downloaded per patient" />
            <column name="description" value="Specifies the maximum number of encounters to be downloaded into mUzima per patient" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-11-27T13:25:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="eb780e26-30a0-4e53-b3da-a3f56f13ccde" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20200418144400" author="bmokaya">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="expanded_cohort_update_history" columnName="members_added"/>
            </and>
        </preConditions>
        <comment>
            Alter column members_added from text to longtext
        </comment>
        <modifyColumn tableName="expanded_cohort_update_history">
            <column name="members_added" type="${clob.type}"></column>
        </modifyColumn>
    </changeSet>

    <changeSet id="muzima-20200418144500" author="bmokaya">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="expanded_cohort_update_history" columnName="members_added"/>
            </and>
        </preConditions>
        <comment>
            Alter column members_removed from text to longtext
        </comment>
        <modifyColumn tableName="expanded_cohort_update_history">
            <column name="members_removed" type="${clob.type}"></column>
        </modifyColumn>
    </changeSet>

    <changeSet id="muzima-20200320140300" author="bmokaya" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="expanded_cohort_definition" columnName="enable_filter_by_provider"/>
            </not>
        </preConditions>
        <comment>
            Adding the enable_filter_by_provider column to expanded_cohort_definition
        </comment>
        <addColumn tableName="expanded_cohort_definition">
            <column name="enable_filter_by_provider" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-20200320140400" author="bmokaya" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="expanded_cohort_definition" columnName="enable_filter_by_location"/>
            </not>
        </preConditions>
        <comment>
            Adding the enable_filter_by_location column to expanded_cohort_definition
        </comment>
        <addColumn tableName="expanded_cohort_definition">
            <column name="enable_filter_by_location" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-20200320140500" author="bmokaya" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="expanded_cohort_definition" columnName="filter_query"/>
            </not>
        </preConditions>
        <comment>
            Adding the filter_query column to expanded_cohort_definition
        </comment>
        <addColumn tableName="expanded_cohort_definition">
            <column name="filter_query" type="text" />
        </addColumn>
    </changeSet>

    <changeSet id="muzima-20200324125000" author="bmokaya">
        <preConditions onFail="MARK_RAN">
            <not><tableExists tableName="muzima_cohort_metadata"/></not>
        </preConditions>
        <comment>
            Creating the muzima_cohort_metadata
        </comment>
        <createTable tableName="muzima_cohort_metadata">
            <column name="id" type="int"  autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cohort_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="patient_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="location_id" type="int"/>
            <column name="provider_id" type="int"/>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="voided" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="voided_by" type="int"/>
            <column name="date_voided" type="datetime"/>
            <column name="void_reason" type="varchar(255)" defaultValue="null"/>
        </createTable>
        <addForeignKeyConstraint constraintName="muzima_cohort_metadata_creator"
                                 baseTableName="muzima_cohort_metadata" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_cohort_metadata_changed_by"
                                 baseTableName="muzima_cohort_metadata" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_cohort_metadata_voided_by"
                                 baseTableName="muzima_cohort_metadata" baseColumnNames="voided_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_cohort_metadata_cohort_id"
                                 baseTableName="muzima_cohort_metadata" baseColumnNames="cohort_id"
                                 referencedTableName="cohort" referencedColumnNames="cohort_id"/>
        <addForeignKeyConstraint constraintName="muzima_cohort_metadata_patient_id"
                                 baseTableName="muzima_cohort_metadata" baseColumnNames="patient_id"
                                 referencedTableName="patient" referencedColumnNames="patient_id"/>
        <addForeignKeyConstraint constraintName="muzima_cohort_metadata_location_id"
                                 baseTableName="muzima_cohort_metadata" baseColumnNames="location_id"
                                 referencedTableName="location" referencedColumnNames="location_id"/>
        <addForeignKeyConstraint constraintName="muzima_cohort_metadata_provider_id"
                                 baseTableName="muzima_cohort_metadata" baseColumnNames="provider_id"
                                 referencedTableName="provider" referencedColumnNames="provider_id"/>

    </changeSet>

    <changeSet id="muzima-20200527124000" author="bmokaya">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM visit_type where uuid = '1d697d92-a000-11ea-b1a0-d0577bb73cd4';
            </sqlCheck>
        </preConditions>
        <comment>Add a mUzima default visit type</comment>
        <insert tableName="visit_type">
            <column name="name" value="mUzima Visit" />
            <column name="description" value="Default mUzima Visit" />
            <column name="date_created" valueDate="2020-05-27T12:40:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="1d697d92-a000-11ea-b1a0-d0577bb73cd4" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20200527124500" author="bmokaya">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_setting where uuid = '4ad0a034-a001-11ea-b1a0-d0577bb73cd4';
            </sqlCheck>
        </preConditions>
        <comment>Add a mUzima default visit type setting</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="mUzima.DefaultVisitType" />
            <column name="name" value="Default mUzima visit type" />
            <column name="description" value="Defines the default visit type that will be used while processing mUzima forms. Value is the uuid of the visit type" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_string" value="1d697d92-a000-11ea-b1a0-d0577bb73cd4" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2020-05-27T12:45:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="4ad0a034-a001-11ea-b1a0-d0577bb73cd4" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20200528133000" author="bmokaya">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_setting where uuid = '457f8262-a0ce-11ea-b1a0-d0577bb73cd4';
            </sqlCheck>
        </preConditions>
        <comment>Add a mUzima encounter-visit mapping status</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="VisitCreation.isEnabled" />
            <column name="name" value="mUzima encounter-visit creation status" />
            <column name="description" value="Defines whether visit should be created if not existing or mapped to encounter while processing mUzima form data." />
            <column name="setting_data_type" value="BOOLEAN" />
            <column name="value_boolean" valueBoolean="true" />
            <column name="date_created" valueDate="2020-05-28T13:30:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="457f8262-a0ce-11ea-b1a0-d0577bb73cd4" />
        </insert>
    </changeSet>
    <changeSet id="muzima-20201106144400" author="mssavai">
    <preConditions onFail="MARK_RAN">
        <sqlCheck expectedResult="0">
            SELECT COUNT(*) FROM muzima_setting where uuid = '2ef34fe0-9d39-4dc7-9839-c366557e94cb';
        </sqlCheck>
    </preConditions>
    <comment>Enforce demographics update manual review</comment>
    <insert tableName="muzima_setting">
        <column name="property" value="DemographicsUpdateManualReviewEnforcement.isEnabled"/>
        <column name="name" value="Demographics update manual review requirement status" />
        <column name="description" value="Specifies whether manual review is required for update of specific demographics fields such as
            gender and birthdate." />
        <column name="setting_data_type" value="BOOLEAN" />
        <column name="value_boolean" valueBoolean="true" />
        <column name="date_created" valueDate="2020-11-06T14:44:00" />
        <column name="creator" value="1" />
        <column name="uuid" value="2ef34fe0-9d39-4dc7-9839-c366557e94cb" />
    </insert>
    </changeSet>

    <changeSet id="muzima-20201112115000" author="bmokaya">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_setting where uuid = '134bc6be-24c4-11eb-940f-d0577bb73cd4';
            </sqlCheck>
        </preConditions>
        <comment>Add maximum obs per patient and concept setting</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="Obs.maximumDownloadSize"/>
            <column name="name" value="Maximum number of observations downloaded per patient for a given concept" />
            <column name="description" value="Specifies the maximum number of observations to be downloaded into mUzima app per patient for each concept" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_string" value="3" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2020-11-12T11:50:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="134bc6be-24c4-11eb-940f-d0577bb73cd4" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20200810150300" author="bmokaya">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_cohort_report_config"/>
            </not>
        </preConditions>
        <createTable tableName="muzima_cohort_report_config">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cohort_uuid" type="char(38)">
                <constraints nullable="false"/>
            </column>
            <column name="report_design_uuid" type="char(38)">
                <constraints nullable="false"/>
            </column>
            <column name="priority" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int" />
            <column name="date_changed" type="datetime"/>
            <column name="retired" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="retired_by" type="int"/>
            <column name="date_retired" type="datetime"/>
            <column name="retire_reason" type="varchar(255)" defaultValue="null"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzima_cohort_report_config_creator"
                                 baseTableName="muzima_cohort_report_config" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_cohort_report_config_changed_by"
                                 baseTableName="muzima_cohort_report_config" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_cohort_report_config_retired_by"
                                 baseTableName="muzima_cohort_report_config" baseColumnNames="retired_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
    </changeSet>

    <changeSet id="muzima-20201123083000" author="bmokaya" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config where schedulable_class =
                'org.openmrs.module.muzima.task.ProcessQueueDataTask'
            </sqlCheck>
        </preConditions>
        <comment>Add ProcessQueueDataTask to scheduler</comment>
        <sql>
            INSERT INTO  scheduler_task_config  (name, description, schedulable_class,
            start_time, start_time_pattern, repeat_interval, start_on_startup, started,
            created_by, date_created, changed_by, date_changed, last_execution_time, uuid )
            VALUES ('Process Muzima Queue Data', 'Task to process queue data submitted to the muzima processor.', 'org.openmrs.module.muzima.task.ProcessQueueDataTask',
            '2020-11-23 00:00:00','MM/dd/yyyy HH:mm:ss',3600, 1, 1,
            1, now(), NULL, NULL, NULL, uuid());
        </sql>
    </changeSet>

    <changeSet id="muzima-20201123083500" author="bmokaya" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config where schedulable_class =
                'org.openmrs.module.muzima.task.ProcessExpandedCohortTask'
            </sqlCheck>
        </preConditions>
        <comment>Add ProcessExpandedCohortTask to scheduler</comment>
        <sql>
            INSERT INTO  scheduler_task_config  (name, description, schedulable_class,
            start_time, start_time_pattern, repeat_interval, start_on_startup, started,
            created_by, date_created, changed_by, date_changed, last_execution_time, uuid )
            VALUES ('Generate cohort membership', 'Task to generate cohort membership based on given criteria.', 'org.openmrs.module.muzima.task.ProcessExpandedCohortTask',
            '2020-11-23 00:00:00','MM/dd/yyyy HH:mm:ss',86400, 1, 1,
            1, now(), NULL, NULL, NULL, uuid());
        </sql>
    </changeSet>

    <changeSet id="muzima-20201123084100" author="bmokaya">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM cohort where uuid = 'aefab9d4-2d4e-11eb-8daf-d0577bb73cd4';
            </sqlCheck>
        </preConditions>
        <comment>Add LTFU Cohort</comment>
        <insert tableName="cohort">
            <column name="name" value="Lost to Follow up"/>
            <column name="description" value="List of patients lost to follow up"/>
            <column name="date_created" valueDate="2020-11-23T08:41:00" />
            <column name="creator" value="1" />
            <column name="voided" value="0" />
            <column name="uuid" value="aefab9d4-2d4e-11eb-8daf-d0577bb73cd4" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20201123085000" author="bmokaya">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM cohort where uuid = 'a857790c-2d56-11eb-8daf-d0577bb73cd4';
            </sqlCheck>
        </preConditions>
        <comment>Add Missed Appointment Cohort</comment>
        <insert tableName="cohort">
            <column name="name" value="Missed Appointment"/>
            <column name="description" value="List of patients who have a missed appointment"/>
            <column name="date_created" valueDate="2020-11-23T08:50:00" />
            <column name="creator" value="1" />
            <column name="voided" value="0" />
            <column name="uuid" value="a857790c-2d56-11eb-8daf-d0577bb73cd4" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20201123090500" author="bmokaya" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM expanded_cohort_definition where uuid = 'd147624e-2d58-11eb-8daf-d0577bb73cd4'
            </sqlCheck>
        </preConditions>
        <comment>Add item into expanded cohort definition</comment>
        <sql>
            INSERT INTO expanded_cohort_definition (cohort_id, sql_definition, is_scheduled, creator, date_created, changed_by,
            date_changed, voided, voided_by, date_voided, void_reason, uuid,enable_member_addition,enable_member_removal) VALUES ((select cohort_id from cohort where uuid='aefab9d4-2d4e-11eb-8daf-d0577bb73cd4') ,"select person_id from (select o.person_id, max(o.value_datetime) maxApp,DATEDIFF(now(),max(o.value_datetime)) datedif from obs o left join person p on p.person_id=o.person_id
            where o.concept_id=5096 and p.voided='false' group by o.person_id having datedif between 30 and 90) t",
            1, 1, now(), NULL, NULL, 0, NULL, NULL, NULL, 'd147624e-2d58-11eb-8daf-d0577bb73cd4',1,1);
        </sql>
    </changeSet>

    <changeSet id="muzima-20201123095400" author="bmokaya" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM expanded_cohort_definition where uuid = '9404d22e-08c8-4bc0-bfdf-f027285f6b21'
            </sqlCheck>
        </preConditions>
        <comment>Add item into expanded cohort definition</comment>
        <sql>
            INSERT INTO expanded_cohort_definition (cohort_id, sql_definition, is_scheduled, creator, date_created, changed_by,
            date_changed, voided, voided_by, date_voided, void_reason, uuid,enable_member_addition,enable_member_removal) VALUES ((select cohort_id from cohort where
            uuid='a857790c-2d56-11eb-8daf-d0577bb73cd4') ,"select person_id from (select o.person_id,max(o.value_datetime)
            maxApp,DATEDIFF(now(),max(o.value_datetime)) datedif from obs o left join person p on p.person_id=o.person_id
            where o.concept_id=5096 and p.voided='false' group by o.person_id having datedif between 7 and 31) t",
            1, 1, now(), NULL, NULL, 0, NULL, NULL, NULL, '9404d22e-08c8-4bc0-bfdf-f027285f6b21',1,1);
        </sql>
    </changeSet>

    <changeSet id="muzima-20201123103000" author="bmokaya" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_form where uuid = 'e8805c90-8792-4f39-a37a-e5f3aee0d00d'
            </sqlCheck>
        </preConditions>
        <comment>Add tracking form</comment>
        <sql>
            <![CDATA[
            insert into muzima_form(form_id,model_xml, form_html, model_json, creator, date_created, changed_by, date_changed, retired, retired_by, date_retired, retire_reason, uuid, discriminator, form, meta_json) values((select case when max(form_id) is null then 1 else max(form_id)+1 end from muzima_form f),NULL, '<html xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
            <head>
                <link href="css/bootstrap.min.css" rel="stylesheet"/>
                <link href="css/muzima.css" rel="stylesheet"/>
                <link href="css/ui-darkness/jquery-ui-1.10.4.custom.min.css" rel="stylesheet"/>
                <script src="js/jquery.min.js"></script>
                <script src="js/jquery-ui-1.10.4.custom.min.js"></script>
                <script src="js/jquery.validate.min.js"></script>
                <script src="js/additional-methods.min.js"></script>
                <script src="js/muzima.js"></script>
                <title>Missed Appointment Tracking Register</title>
            </head>
            <body class="col-md-10 col-md-offset-1">
                <div id="pre_populate_data">
                </div>
                <form id="missed_appointment_tracking_register" name="missed_appointment_tracking_register">
                    <h2 class="text-center">Missed Appointment Tracking Register</h2>
                    <div class="section">
                        <h3>Demographics</h3>
                        <div class="form-group">
                            <input class="form-control" id="patient.uuid"
                                   name="patient.uuid" type="hidden" readonly="readonly">
                        </div>
                        <div class="form-group">
                            <label for="patient.medical_record_number">Medical No:</label>
                            <input class="form-control" id="patient.medical_record_number"
                                   name="patient.medical_record_number" type="text"
                                   readonly="readonly">
                        </div>
                        <div class="form-group" style="display:none">
                            <label for="patient.family_name">Family Name:</label>
                            <input class="form-control" id="patient.family_name"
                                   name="patient.family_name" type="text" readonly="readonly">
                        </div>
                        <div class="form-group" style="display:none">
                            <label for="patient.given_name">Given Name:</label>
                            <input class="form-control" id="patient.given_name"
                                   name="patient.given_name" type="text" readonly="readonly">
                        </div>
                        <div class="form-group" style="display:none">
                            <label for="patient.middle_name">Middle Name:</label>
                            <input class="form-control" id="patient.middle_name"
                                   name="patient.middle_name" type="text" readonly="readonly">
                        </div>
                        <div class="form-group">
                            <label for="patient.middle_name">Name:</label>
                            <input class="form-control" id="patient.names"
                                   name="patient.names" type="text" readonly="readonly">
                        </div>
                        <div class="form-group">
                            <label for="patient.sex">Gender:</label>
                            <select class="form-control" id="patient.sex" name="patient.sex" readonly="readonly" disabled>
                                <option value="">...</option>
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="patient.birth_date">Date of birth:</label>
                            <input class="form-control" id="patient.birth_date"
                                   name="patient.birth_date" type="text" readonly="readonly">
                        </div>
                    </div>
                    <div class="section">
                        <h3>Appointment Information</h3>
                        <div class="form-group">
                            <label for="obs.missed_appointment_date">Missed Appointment Date:<span class="required"></span>
                            </label>
                            <input class="form-control" data-concept="166158^Missed Appointment Date^99DCT"  id="obs.missed_appointment_date" name="obs.missed_appointment_date" type="text" readonly="readonly"/>
                        </div>
                        <div class="form-group service_point">
                            <label for="obs.service_point">
                                Service Point<span class="required"></span>
                            </label>
                            <select class="form-control" id="obs.service_point" name="obs.service_point" data-concept="164993^POINT OF CARE^99DCT">
                                <option value="">...</option>
                                <option value="165047^Antiretraviral Treatment Clinic^99DCT">ART Clinic</option>
                                <option value="165048^Tuberculosis Clinic^99DCT">TB Clinic</option>
                                <option value="90002^OTHER SPECIFY^99DCT">Other</option>
                            </select>
                        </div>
                        <div class="form-group" id="other_service_point_div">
                            <div class="form-group">
                                <label for="obs.other_service_point">
                                    Other Service Point
                                    <span class="required"></span>
                                </label>
                                <div class="form-group">
                                    <input type="text" class="form-control" data-concept="165398^Other Point of Care^99DCT" name="obs.other_service_point" id="obs.other_service_point">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="obs.medication_due_for_refill">
                                Medication Due for Refill
                                <span class="required"></span>
                            </label>
                            <div class="form-group">
                                <label for="obs.medication_due_for_refill_art" style="font-weight: normal;">
                                    <input type="checkbox" data-concept="165482^Medication due for refill^99DCT" value="164972^ART Refill^99DCT" name="obs.medication_due_for_refill" id="obs.medication_due_for_refill_art">&nbsp;ART
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="obs.medication_due_for_refill_tb" style="font-weight: normal;">
                                    <input type="checkbox" data-concept="165482^Medication due for refill^99DCT" value="1159^TUBERCULOSIS TREATMENT DRUGS^99DCT" name="obs.medication_due_for_refill" id="obs.medication_due_for_refill_tb">&nbsp;TB Meds/TPT
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="obs.medication_due_for_refill_inc" style="font-weight: normal;">
                                    <input type="checkbox" data-concept="165482^Medication due for refill^99DCT" value="1158^TUBERCULOSIS PROPHYLACTIC DRUGS^99DCT" name="obs.medication_due_for_refill" id="obs.medication_due_for_refill_inc">&nbsp;Infant NVP/CTX
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="obs.medication_due_for_refill_fp" style="font-weight: normal;">
                                    <input type="checkbox" data-concept="165482^Medication due for refill^99DCT" value="5287^FAMILY PLANNING^99DCT" name="obs.medication_due_for_refill" id="obs.medication_due_for_refill_fp">&nbsp;FP
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="obs.medication_due_for_refill_other" style="font-weight: normal;">
                                    <input type="checkbox" data-concept="165482^Medication due for refill^99DCT" value="5622^Other^99DCT" name="obs.medication_due_for_refill" id="obs.medication_due_for_refill_other">&nbsp;Other
                                </label>
                            </div>
                            <div class="form-group" id="medication_due_for_refill_other_div">
                                <label for="obs.medication_due_for_refill_specify">
                                    Other Specify:
                                    <span class="required"></span>
                                </label>
                                <input type="text" class="form-control" data-concept="165483^Other medication due for refill at appointment^99DCT" name="obs.medication_other_specify">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="obs.mode_of_care">
                                Mode of Care<span class="required"></span>
                            </label>
                            <select class="form-control" id="obs.mode_of_care" name="obs.mode_of_care" data-concept="165143^Differentiated Service Delivery^99DCT">
                                <option value="">...</option>
                                <option value="165138^Facility Based Individual Management^99DCT">1 - FBIM</option>
                                <option value="165140^Facility Based Groups^99DCT">2 - FBG</option>
                                <option value="165139^Fast Track Drug Refill^99DCT">3 - FTDR</option>
                                <option value="165142^Community Drug Distribution Point^99DCT">4 - CDDP</option>
                                <option value="165141^Community Client Led ART Delivery^99DCT">5 - CCLAD</option>
                            </select>
                        </div>
                    </div>
                    <div class="section">
                        <h3>Tracking Information</h3>
                        <div class="section group-set concept-set" data-concept="165346^General Follow Up^99DCT" >
                            <div class="form-group">
                                <label for="obs.follow_up_attemp">
                                    Follow Up Attempt<span class="required">*</span>
                                </label>
                                <select class="form-control" id="obs.follow_up_attemp" required name="obs.follow_up_attemp" data-concept="166157^Follow Up Attempts^99DCT">
                                    <option value="">...</option>
                                    <option value="165338^General Follow Up First Attempt^99DCT">1 - Follow Up 1</option>
                                    <option value="165339^General Follow Up Second Attempt^99DCT">2 - Follow Up 2</option>
                                    <option value="165340^General Follow Up Third Attempt^99DCT">3 - Follow Up 3</option>
                                    <option value="165341^General Follow Up Fourth Attempt^99DCT">4 - Follow Up 4</option>
                                    <option value="165342^General Follow Up Fifth Attempt^99DCT">5 - Follow Up 5</option>
                                    <option value="165343^General Follow Up Sixth Attempt^99DCT">6 - Follow Up 6</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="obs.followup_date_date">
                                    Followup Date<span class="required">*</span>
                                </label>
                                <input class="form-control datepicker past-date"  data-concept="165373^Followup Date^99DCT" id="obs.followup_date_date" name="obs.followup_date_date" type="text" readonly="readonly" required>
                            </div>
                            <div class="form-group">
                                <label for="encounter.provider_id_select">
                                    Follow Up Person:<span class="required">*</span>
                                </label>
                                <input class="form-control valid-provider-only" id="encounter.provider_id_select"
                                       type="text" placeholder="Start typing something...">
                                <input class="form-control" name="encounter.provider_id_select" type="hidden">
                            </div>
                            <div class="form-group">
                                <label for="obs.followup_method">
                                    Followup Action<span class="required">*</span>
                                </label>
                                <select class="form-control" id="obs.followup_method" name="obs.followup_method" data-concept="165100^Followup Method^99DCT" required>
                                    <option value=""></option>
                                    <option value="165102^Phonecall^99DCT">Phone call to client/caregiver/next of Kin</option>
                                    <option value="165103^Home visit^99DCT"> Home/workplace visit by HCW</option>
                                    <option value="165336^Facility to Facility Phone Call^99DCT"> Facility to facility phone call</option>
                                    <option value="165337^Facility to Facility Visit^99DCT"> Facility to facility visit</option>
                                    <option value="90002^OTHER SPECIFY^99DCT"> Other</option>
                                </select>
                            </div>
                            <div class="form-group freetext" id="other_follow_up_action_div">
                                <label for="obs.other_follow_up_action/method">
                                    Other Follow up actions<span class="required">*</span>
                                </label>
                                <input class="form-control" id="obs.other_follow_up_action_method" name="obs.other_follow_up_action_method" type="text" data-concept="165481^Other follow up action/method^99DCT" required>
                            </div>
                            <div class="form-group">
                                <label for="obs.followup_outcome">
                                    Follow Up Outcome<span class="required">*</span>
                                </label>
                                <select class="form-control" id="obs.followup_outcome" name="obs.followup_outcome" data-concept="165104^Followup Outcome^99DCT" required>
                                    <option value=""></option>
                                    <option value="165334^Returned to Care^99DCT">1 - Returned to care</option>
                                    <option value="165335^Self Transfered^99DCT"> 2 - Self transferred</option>
                                    <option value="1363^STOPPED^99DCT"> 3 - Stopped/Refused</option>
                                    <option value="165486^Patient migrated/relocated^99DCT"> 4 - Migrated/Relocated</option>
                                    <option value="160034^Died^99DCT"> 5 - Died</option>
                                    <option value="165368^CAN NOT BE TRACED^99DCT"> 6 - Unable to be traced</option>
                                    <option value="165369^Tracing Attempts initiated but incomplete^99DCT"> 7 - Tracing attempts initiated but incomplete</option>
                                    <option value="165370^No Attempt^99DCT"> 8 - No attempt to trace</option>
                                    <option value="165371^Misclassified as missed Appointment^99DCT"> 9 - Misclassified as Missed Appointment</option>
                                </select>
                            </div>
                            <div id="ART_details">
                                <div class="form-group freetext">
                                    <label for="obs.name_of_location_transferred_to">
                                        ART Clinic<span class="required"></span>
                                    </label>
                                    <input class="form-control" id="obs.name_of_location_transferred_to" name="obs.name_of_location_transferred_to" type="text" data-concept="90211^NAME OF LOCATION TRANSFERRED TO^99DCT">
                                </div>
                                <div class="form-group freetext">
                                    <label for="obs.art_number">ART Number</label>
                                    <input class="form-control" id="obs.art_number" name="obs.art_number" type="text" data-concept="99431^ART Number^99DCT">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="obs.followup_outcome_by_end_of_current_quarter">Followup outcome by end of current quarter</label>
                            <select class="form-control" id="obs.followup_outcome_by_end_of_current_quarter" name="obs.followup_outcome_by_end_of_current_quarter" data-concept="165484^Followup outcome by end of current quarter^99DCT">
                                <option value=""></option>
                                <option value="165334^Returned to Care^99DCT">1 - Returned to care</option>
                                <option value="165335^Self Transfered^99DCT"> 2 - Self transferred</option>
                                <option value="1363^STOPPED^99DCT"> 3 - Stopped/Refused</option>
                                <option value="165486^Patient migrated/relocated^99DCT"> 4 - Migrated/Relocated</option>
                                <option value="160034^Died^99DCT"> 5 - Died</option>
                                <option value="165368^CAN NOT BE TRACED^99DCT"> 6 - Unable to be traced</option>
                                <option value="165369^Tracing Attempts initiated but incomplete^99DCT"> 7 - Tracing attempts initiated but incomplete</option>
                                <option value="165370^No Attempt^99DCT"> 8 - No attempt to trace</option>
                                <option value="165371^Misclassified as missed Appointment^99DCT"> 9 - Misclassified as Missed Appointment</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="obs.followup_outcome_by_end_of_next_quarter">Followup outcome by end of next quarter</label>
                            <select class="form-control" id="obs.followup_outcome_by_end_of_next_quarter" name="obs.followup_outcome_by_end_of_next_quarter" data-concept="165485^Followup outcome by end of next quarter^99DCT">
                                <option value="" selected="true"></option>
                                <option value="165334^Returned to Care^99DCT">1 - Returned to care</option>
                                <option value="165335^Self Transfered^99DCT"> 2 - Self transferred</option>
                                <option value="1363^STOPPED^99DCT"> 3 - Stopped/Refused</option>
                                <option value="165486^Patient migrated/relocated^99DCT"> 4 - Migrated/Relocated</option>
                                <option value="160034^Died^99DCT"> 5 - Died</option>
                                <option value="165368^CAN NOT BE TRACED^99DCT"> 6 - Unable to be traced</option>
                                <option value="165369^Tracing Attempts initiated but incomplete^99DCT"> 7 - Tracing attempts initiated but incomplete</option>
                                <option value="165370^No Attempt^99DCT"> 8 - No attempt to trace</option>
                                <option value="165371^Misclassified as missed Appointment^99DCT"> 9 - Misclassified as Missed Appointment</option>
                            </select>
                        </div>
                        <div class="form-group" id="returned_to_care_date">
                            <label for="obs.date_client_returned_date">Date Returned to Care</label>
                            <input class="form-control datepicker past-date" id="obs.date_client_returned_date" name="obs.date_client_returned_date" data-concept="165378^Date Client Returned^99DCT" type="text" readonly="readonly">
                        </div>
                        <div class="form-group" id="self_transfered_date">
                            <label for="obs.transfer_out_date_date">Date Self Transferred</label>
                            <input class="form-control datepicker past-date" id="obs.transfer_out_date_date" name="obs.transfer_out_date_date"  data-concept="99165^TRANSFER OUT DATE^99DCT" type="text" readonly="readonly">
                        </div>
                        <div class="form-group" id="cause_of_death">
                            <label for="obs.cause_of_death">CAUSE OF DEATH</label>
                            <select class="form-control" id="obs.cause_of_death" name="obs.cause_of_death" data-concept="5002^CAUSE OF DEATH^99DCT">
                                <option value=""></option>
                                <option value="58^TUBERCULOSIS^99DCT">1 - TB</option>
                                <option value="116030^Cancer^99DCT"> 2 - Cancer</option>
                                <option value="165374^Infectious Disease other than TB^99DCT"> 3 - Infectious disease other than TB</option>
                                <option value="165375^HIV Non-infectious Disease^99DCT"> 4 - HIV Non-infectious disease</option>
                                <option value="165376^Natural Causes^99DCT"> 5 - Natural causes</option>
                                <option value="165377^Non natural causes^99DCT"> 6 - Non natural causes</option>
                                <option value="90001^UNKNOWN^99DCT"> 7 - Unknown</option>
                            </select>
                        </div>
                        <div class="form-group freetext">
                            <label for="obs.clinical_impression_comment">Clinical impression comment </label>
                            <input type="text" class="form-control" name="obs.clinical_impression_comment" id="obs.clinical_impression_comment" data-concept="159395^Clinical impression comment^99DCT">
                        </div>
                    </div>
                    <div class="section">
                        <div class="form-group">
                            <input class="form-control" id="encounter.form_uuid" name="encounter.form_uuid" type="hidden" required="required"/>
                            <input class="form-control" id="encounter.provider_role_uuid" name="encounter.provider_role_uuid" type="hidden" value="240b26f9-dd88-4172-823d-4a8bfeb7841f"/>
                        </div>
                        <div class="form-group">
                            <label for="encounter.encounter_datetime">Encounter Date:<span class="required">*</span>
                            </label>
                            <input class="form-control nonFutureDate past-date" id="encounter.encounter_datetime"
                                   name="encounter.encounter_datetime" type="text" readonly="readonly"
                                   required="required"/>
                        </div>
                        <div class="form-group show_provider_id_text" style="display:none">
                            <label for="encounter.provider_id">Follow Up Person\'s System ID:<span class="required">*</span></label>
                            <input class="form-control checkDigit" id="encounter.provider_id" disabled name="encounter.provider_id"
                                   type="text" required="required"  placeholder="Provider Id">
                        </div>
                        <div class="form-group">
                            <label for="encounter.location_id">Encounter Location:<span class="required">*</span></label>
                            <input class="form-control valid-location-only" id="encounter.location_id" type="text" placeholder="Start typing something..." required="required"/>
                            <input class="form-control" name="encounter.location_id" type="hidden"/>
                        </div>
                    </div>
                </form>
            </body>
            <script type="text/javascript">
                $(document).ready(function () {
                $("#save_draft").click(function () {
                $(this).prop("disabled", true)
                document.saveDraft()
                $(this).prop("disabled", false)
                })

                $("#submit_form").click(function () {
                $(this).prop("disabled", true)
                document.submit()
                $(this).prop("disabled", false)
                })

                var dateFormat = "dd-mm-yy"
                var currentDate = $.datepicker.formatDate(dateFormat, new Date())
                var encounterDatetime = $("#encounter\\\\.encounter_datetime")
                if ($(encounterDatetime).val() == "") {
                $(encounterDatetime).val(currentDate)
                }

                var followupDate = $("#obs\\\\.followup_date_date")
                if ($(followupDate).val() == "") {
                $(followupDate).val(currentDate)
                }

                $("#obs\\\\.service_point").change(function(){
                if($(this).val() == "90002^OTHER SPECIFY^99DCT"){
                $("#other_service_point_div").show()
                } else{
                $("#other_service_point_div").hide()
                }
                })
                $("#obs\\\\.service_point").trigger("change")

                $("#obs\\\\.medication_due_for_refill_other").change(function(){
                if($(this).prop( "checked" )){
                $("#medication_due_for_refill_other_div").show()
                } else{
                $("#medication_due_for_refill_other_div").hide()
                }
                })
                $("#obs\\\\.medication_due_for_refill_other").trigger("change")

                $("#obs\\\\.followup_method").change(function(){
                if($(this).val() == "90002^OTHER SPECIFY^99DCT"){
                $("#other_follow_up_action_div").show()
                } else{
                $("#other_follow_up_action_div").hide()
                }
                })
                $("#obs\\\\.followup_method").trigger("change")

                document.setupAutoCompleteData("encounter\\\\.location_id")
                document.setupAutoCompleteDataForProvider("encounter\\\\.provider_id_select")
                document.setupValidationForLocation("$(\'#encounter\\\\.location_id\').val()","encounter\\\\.location_id")
                document.setupValidationForProvider("$(\'#encounter\\\\.provider_id_select\').val()","encounter\\\\.provider_id")

                $("#obs\\\\.followup_date_date").change(function(){
                $("#encounter\\\\.encounter_datetime").val($("#obs\\\\.followup_date_date").val())
                })
                $("#obs\\\\.followup_date_date").trigger("change")

                var prePopulateData = $.trim($("#pre_populate_data").html())
                var prePopulateJSON = JSON.parse(prePopulateData)
                $.each(prePopulateJSON, function(key, value) {
                if (key === "patient") {
                var names = ""
                $.each(value, function(keys, values) {
                if(keys === "patient.given_name" || keys === "patient.middle_name" || keys === "patient.family_name"){
                names=names+" "+values
                }
                if(keys === "patient.birth_date"){
                var tmp = values.split("-")
                var birthDate = new Date(tmp[2],tmp[1]-1,tmp[0])
                var today = new Date()
                var milliSecondsInAYear = 1000 * 60 * 60 * 24 * 365.26
                var age = (today - birthDate) / milliSecondsInAYear
                $("#patient\\\\.age").val((Math.floor(age)+" Years "))
                }
                })
                $("#patient\\\\.names").val(names)
                }
                })

                var patientuuid = $("#patient\\\\.uuid").val()
                var lastAppointmentDate = htmlDataStore.getObsByConceptId(patientuuid,5096)
                lastAppointmentDate = JSON.parse(lastAppointmentDate)
                var lastAppointmentDateSize = lastAppointmentDate.length-1
                if(parseInt(lastAppointmentDateSize)>-1){
                if(lastAppointmentDate[0].valueDatetime!=""){
                var appointmentDate = lastAppointmentDate[0].valueDatetime
                }else{
                var appointmentDate = lastAppointmentDate[0].valueText
                }
                $("#obs\\\\.missed_appointment_date").val(appointmentDate)
                }

                var followupOutcome = $("#obs\\\\.followup_outcome")
                followupOutcome.change(function () {
                if ($("#obs\\\\.followup_outcome").val() == "165335^Self Transfered^99DCT") {
                $("#ART_details").show()
                $("#self_transfered_date").hide()
                $("#returned_to_care_date").hide()
                $("#cause_of_death").hide()
                } else if($("#obs\\\\.followup_outcome").val() == "165334^Returned to Care^99DCT"){
                $("#ART_details").hide()
                $("#self_transfered_date").hide()
                $("#returned_to_care_date").show()
                $("#cause_of_death").hide()
                }	else if($("#obs\\\\.followup_outcome").val() == "165335^Self Transfered^99DCT"){
                $("#ART_details").hide()
                $("#self_transfered_date").show()
                $("#returned_to_care_date").hide()
                $("#cause_of_death").hide()
                }	else if($("#obs\\\\.followup_outcome").val() == "160034^Died^99DCT"){
                $("#ART_details").hide()
                $("#self_transfered_date").hide()
                $("#returned_to_care_date").hide()
                $("#cause_of_death").show()
                }	else {
                $("#ART_details").hide()
                $("#self_transfered_date").hide()
                $("#returned_to_care_date").hide()
                $("#cause_of_death").hide()
                }
                })
                followupOutcome.trigger("change")
                })
            </script>
        </html>', NULL, 1, now(), NULL, NULL, 0, NULL, NULL, NULL, 'e8805c90-8792-4f39-a37a-e5f3aee0d00d', 'json-encounter', '59d9341a-f65e-4e86-a98b-415ea54dfa81', NULL);
        ]]>
        </sql>
    </changeSet>
    <changeSet id="muzima-20201124094000" author="bmokaya" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_config where uuid = '0e1202f5-5233-4f6e-8c67-c3a6aec6658f'
            </sqlCheck>
        </preConditions>
        <comment>Add a setup config for patient tracing</comment>
        <sql>
            insert into muzima_config(name,description,config_json,creator,date_created,changed_by,date_changed,retired,retired_by,date_retired,retire_reason,uuid) values('Patient Tracing','Patient Tracing Config','{"config":{"settings":[{"datatype":"BOOLEAN","name":"Relationships status","property":"Relationships.isEnabled","description":"Specifies if Relationships feature will be enabled for this implementation","uuid":"f8c4ea54-9e8f-4f47-86c1-ab52f0bc719f","value":true},{"datatype":"STRING","name":"Maximum number of Encounters downloaded per patient","property":"Encounter.maxDownloadSize","description":"Specifies the maximum number of encounters to be downloaded into mUzima per patient","uuid":"eb780e26-30a0-4e53-b3da-a3f56f13ccde","value":"3"},{"datatype":"STRING","name":"Maximum number of observations downloaded per patient for a given concept","property":"Obs.maximumDownloadSize","description":"Specifies the maximum number of observations to be downloaded into mUzima app per patient for each concept","uuid":"134bc6be-24c4-11eb-940f-d0577bb73cd4","value":"3"}],"concepts":[{"name":"RETURN VISIT DATE","uuid":"dcac04cf-30ab-102d-86b0-7a5022ba4115"},{"name":"Rescheduled Return Visit Date","uuid":"d12d1edd-8a71-4c18-bd0a-7ce760556cf1"},{"name":"Home visit date","uuid":"97db7855-2727-413b-ab37-96b0bd71286e"},{"name":"Next Followup Date","uuid":"5d740896-2998-4f0a-8f37-4e10daeb859b"},{"name":"Return Visit Type","uuid":"160530AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"},{"name":"Followup Outcome","uuid":"8f889d84-8e5c-4a66-970d-458d6d01e8a4"},{"name":"Other Follow Up Type","uuid":"79325562-bc68-4f75-bb53-5655dd6de2a8"},{"name":"Next Follow-up Action","uuid":"2de5fa83-ee8b-4543-84e1-de6be326133c"},{"name":"Followup Method","uuid":"928c4617-436e-44b3-91c3-725cb1c910c0"},{"name":"NAME OF LOCATION TRANSFERRED TO","uuid":"dce015bb-30ab-102d-86b0-7a5022ba4115"},{"name":"CAUSE OF DEATH","uuid":"dca2c3f2-30ab-102d-86b0-7a5022ba4115"},{"name":"POINT OF CARE","uuid":"164993AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"},{"name":"Date Client Returned","uuid":"d2d437fb-ff88-44c2-bf17-1d35bde6f586"},{"name":"Missed Appointment Date","uuid":"f6ff7aad-1801-409d-be8d-6f41057777ae"},{"name":"Other Point of Care","uuid":"295467d1-289d-41da-95b0-b006873ef092"},{"name":"Follow Up Attempts","uuid":"b8b3433e-3e9d-42c2-bc1b-1e60421d09d7"},{"name":"TRANSFER OUT DATE","uuid":"fc1b1e96-4afb-423b-87e5-bb80d451c967"},{"name":"Followup outcome by end of next quarter","uuid":"04afa790-1600-4078-818d-4a71a014f073"},{"name":"Differentiated Service Delivery","uuid":"73312fee-c321-11e8-a355-529269fb1459"},{"name":"ART Number","uuid":"105ef9de-ad90-4c08-bcd5-ab48f74f6287"},{"name":"Followup outcome by end of current quarter","uuid":"cd14792c-03e3-47ac-9e08-846ab1d93c87"},{"name":"Other medication due for refill at appointment","uuid":"d7bb22cc-f618-4204-ba72-5705b5daa3bf"},{"name":"Followup Date","uuid":"6eb65cbd-4eab-4343-810b-b831144954e4"},{"name":"Medication due for refill","uuid":"3890b48d-cbbd-47ee-927b-1ac72542c04a"},{"name":"Other follow up action\/method","uuid":"0b49c094-f46e-4a43-a9ec-6f0452c2ccf6"},{"name":"Clinical impression comment","uuid":"159395AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"}],"name":"Patient Tracing","description":"Patient Tracing","locations":[],"forms":[{"name":"HMIS ACP 007 Missed Appointment Tracking Form","uuid":"e8805c90-8792-4f39-a37a-e5f3aee0d00d"}],"providers":[],"cohorts":[{"isFilterByProviderEnabled":false,"isFilterByLocationEnabled":false,"name":"Missed Appointment","description":"Missed Appointment","uuid":"a857790c-2d56-11eb-8daf-d0577bb73cd4"},{"isFilterByProviderEnabled":false,"isFilterByLocationEnabled":false,"name":"Lost to Follow up","description":"Lost to Follow up","uuid":"aefab9d4-2d4e-11eb-8daf-d0577bb73cd4"}]}}',1,now(),NULL,NULL,0,NULL,NULL,NULL,'0e1202f5-5233-4f6e-8c67-c3a6aec6658f');
        </sql>
    </changeSet>
    <changeSet id="muzima-20201214184500" author="bmokaya">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM muzima_form where uuid = 'e8805c90-8792-4f39-a37a-e5f3aee0d00d'
            </sqlCheck>
        </preConditions>
        <comment>update tracking form</comment>
        <sql>
            <![CDATA[
            update muzima_form set form_html='<html xmlns="http://www.w3.org/1999/html"
             xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
            <head>
                <link href="css/bootstrap.min.css" rel="stylesheet"/>
                <link href="css/muzima.css" rel="stylesheet"/>
                <link href="css/ui-darkness/jquery-ui-1.10.4.custom.min.css" rel="stylesheet"/>
                <script src="js/jquery.min.js"></script>
                <script src="js/jquery-ui-1.10.4.custom.min.js"></script>
                <script src="js/jquery.validate.min.js"></script>
                <script src="js/additional-methods.min.js"></script>
                <script src="js/muzima.js"></script>
                <title>Missed Appointment Tracking Register</title>
            </head>
            <body class="col-md-10 col-md-offset-1">
                <div id="pre_populate_data">
                </div>
                <form id="missed_appointment_tracking_register" name="missed_appointment_tracking_register">
                    <h2 class="text-center">Missed Appointment Tracking Register</h2>
                    <div class="section">
                        <h3>Demographics</h3>
                        <div class="form-group">
                            <input class="form-control" id="patient.uuid"
                                   name="patient.uuid" type="hidden" readonly="readonly">
                        </div>
                        <div class="form-group">
                            <label for="patient.medical_record_number">HIV clinic number:</label>
                            <input class="form-control" id="patient.medical_record_number"
                                   name="patient.medical_record_number" type="text"
                                   readonly="readonly">
                        </div>
                        <div class="form-group" style="display:none">
                            <label for="patient.family_name">Family Name:</label>
                            <input class="form-control" id="patient.family_name"
                                   name="patient.family_name" type="text" readonly="readonly">
                        </div>
                        <div class="form-group" style="display:none">
                            <label for="patient.given_name">Given Name:</label>
                            <input class="form-control" id="patient.given_name"
                                   name="patient.given_name" type="text" readonly="readonly">
                        </div>
                        <div class="form-group" style="display:none">
                            <label for="patient.middle_name">Middle Name:</label>
                            <input class="form-control" id="patient.middle_name"
                                   name="patient.middle_name" type="text" readonly="readonly">
                        </div>
                        <div class="form-group">
                            <label for="patient.middle_name">Name:</label>
                            <input class="form-control" id="patient.names"
                                   name="patient.names" type="text" readonly="readonly">
                        </div>
                        <div class="form-group">
                            <label for="patient.sex">Gender:</label>
                            <select class="form-control" id="patient.sex" name="patient.sex" readonly="readonly" disabled>
                                <option value="">...</option>
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="patient.birth_date">Date of birth:</label>
                            <input class="form-control" id="patient.birth_date"
                                   name="patient.birth_date" type="text" readonly="readonly">
                        </div>
                    </div>
                    <div class="section">
                        <h3>Appointment Information</h3>
                        <div class="form-group">
                            <label for="obs.missed_appointment_date">Missed Appointment Date:<span class="required"></span>
                            </label>
                            <input class="form-control" data-concept="166158^Missed Appointment Date^99DCT"  id="obs.missed_appointment_date" name="obs.missed_appointment_date" type="text" readonly="readonly"/>
                        </div>
                        <div class="form-group service_point">
                            <label for="obs.service_point">
                                Service Point<span class="required"></span>
                            </label>
                            <select class="form-control" id="obs.service_point" name="obs.service_point" data-concept="164993^POINT OF CARE^99DCT">
                                <option value="">...</option>
                                <option value="165047^Antiretraviral Treatment Clinic^99DCT">ART Clinic</option>
                                <option value="165048^Tuberculosis Clinic^99DCT">TB Clinic</option>
                                <option value="90002^OTHER SPECIFY^99DCT">Other</option>
                            </select>
                        </div>
                        <div class="form-group" id="other_service_point_div">
                            <div class="form-group">
                                <label for="obs.other_service_point">
                                    Other Service Point
                                    <span class="required"></span>
                                </label>
                                <div class="form-group">
                                    <input type="text" class="form-control" data-concept="165398^Other Point of Care^99DCT" name="obs.other_service_point" id="obs.other_service_point">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="obs.medication_due_for_refill">
                                Medication Due for Refill
                                <span class="required"></span>
                            </label>
                            <div class="form-group">
                                <label for="obs.medication_due_for_refill_art" style="font-weight: normal;">
                                    <input type="checkbox" data-concept="165482^Medication due for refill^99DCT" value="164972^ART Refill^99DCT" name="obs.medication_due_for_refill" id="obs.medication_due_for_refill_art">&nbsp;ART
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="obs.medication_due_for_refill_tb" style="font-weight: normal;">
                                    <input type="checkbox" data-concept="165482^Medication due for refill^99DCT" value="1159^TUBERCULOSIS TREATMENT DRUGS^99DCT" name="obs.medication_due_for_refill" id="obs.medication_due_for_refill_tb">&nbsp;TB Meds/TPT
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="obs.medication_due_for_refill_inc" style="font-weight: normal;">
                                    <input type="checkbox" data-concept="165482^Medication due for refill^99DCT" value="1158^TUBERCULOSIS PROPHYLACTIC DRUGS^99DCT" name="obs.medication_due_for_refill" id="obs.medication_due_for_refill_inc">&nbsp;Infant NVP/CTX
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="obs.medication_due_for_refill_fp" style="font-weight: normal;">
                                    <input type="checkbox" data-concept="165482^Medication due for refill^99DCT" value="5287^FAMILY PLANNING^99DCT" name="obs.medication_due_for_refill" id="obs.medication_due_for_refill_fp">&nbsp;FP
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="obs.medication_due_for_refill_other" style="font-weight: normal;">
                                    <input type="checkbox" data-concept="165482^Medication due for refill^99DCT" value="5622^Other^99DCT" name="obs.medication_due_for_refill" id="obs.medication_due_for_refill_other">&nbsp;Other
                                </label>
                            </div>
                            <div class="form-group" id="medication_due_for_refill_other_div">
                                <label for="obs.medication_due_for_refill_specify">
                                    Other Specify:
                                    <span class="required"></span>
                                </label>
                                <input type="text" class="form-control" data-concept="165483^Other medication due for refill at appointment^99DCT" name="obs.medication_other_specify">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="obs.mode_of_care">
                                Mode of Care<span class="required"></span>
                            </label>
                            <select class="form-control" id="obs.mode_of_care" name="obs.mode_of_care" data-concept="165143^Differentiated Service Delivery^99DCT">
                                <option value="">...</option>
                                <option value="165138^Facility Based Individual Management^99DCT">1 - FBIM</option>
                                <option value="165140^Facility Based Groups^99DCT">2 - FBG</option>
                                <option value="165139^Fast Track Drug Refill^99DCT">3 - FTDR</option>
                                <option value="165142^Community Drug Distribution Point^99DCT">4 - CDDP</option>
                                <option value="165141^Community Client Led ART Delivery^99DCT">5 - CCLAD</option>
                            </select>
                        </div>
                    </div>
                    <div class="section">
                        <h3>Tracking Information</h3>
                        <div class="section group-set concept-set" data-concept="165346^General Follow Up^99DCT" >
                            <div class="form-group">
                                <label for="obs.follow_up_attemp">
                                    Follow Up Attempt<span class="required">*</span>
                                </label>
                                <select class="form-control" id="obs.follow_up_attemp" required name="obs.follow_up_attemp" data-concept="166157^Follow Up Attempts^99DCT">
                                    <option value="">...</option>
                                    <option value="165338^General Follow Up First Attempt^99DCT">1 - Follow Up 1</option>
                                    <option value="165339^General Follow Up Second Attempt^99DCT">2 - Follow Up 2</option>
                                    <option value="165340^General Follow Up Third Attempt^99DCT">3 - Follow Up 3</option>
                                    <option value="165341^General Follow Up Fourth Attempt^99DCT">4 - Follow Up 4</option>
                                    <option value="165342^General Follow Up Fifth Attempt^99DCT">5 - Follow Up 5</option>
                                    <option value="165343^General Follow Up Sixth Attempt^99DCT">6 - Follow Up 6</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="obs.followup_date_date">
                                    Followup Date<span class="required">*</span>
                                </label>
                                <input class="form-control datepicker past-date"  data-concept="165373^Followup Date^99DCT" id="obs.followup_date_date" name="obs.followup_date_date" type="text" readonly="readonly" required>
                            </div>
                            <div class="form-group">
                                <label for="encounter.provider_id_select">
                                    Follow Up Person:<span class="required">*</span>
                                </label>
                                <input class="form-control valid-provider-only" id="encounter.provider_id_select"
                                       type="text" placeholder="Start typing something...">
                                <input class="form-control" name="encounter.provider_id_select" type="hidden">
                            </div>
                            <div class="form-group">
                                <label for="obs.followup_method">
                                    Followup Action<span class="required">*</span>
                                </label>
                                <select class="form-control" id="obs.followup_method" name="obs.followup_method" data-concept="165100^Followup Method^99DCT" required>
                                    <option value=""></option>
                                    <option value="165102^Phonecall^99DCT">Phone call to client/caregiver/next of Kin</option>
                                    <option value="165103^Home visit^99DCT"> Home/workplace visit by HCW</option>
                                    <option value="165336^Facility to Facility Phone Call^99DCT"> Facility to facility phone call</option>
                                    <option value="165337^Facility to Facility Visit^99DCT"> Facility to facility visit</option>
                                    <option value="90002^OTHER SPECIFY^99DCT"> Other</option>
                                </select>
                            </div>
                            <div class="form-group freetext" id="other_follow_up_action_div">
                                <label for="obs.other_follow_up_action/method">
                                    Other Follow up actions<span class="required">*</span>
                                </label>
                                <input class="form-control" id="obs.other_follow_up_action_method" name="obs.other_follow_up_action_method" type="text" data-concept="165481^Other follow up action/method^99DCT" required>
                            </div>
                            <div class="form-group">
                                <label for="obs.followup_outcome">
                                    Follow Up Outcome<span class="required">*</span>
                                </label>
                                <select class="form-control" id="obs.followup_outcome" name="obs.followup_outcome" data-concept="165104^Followup Outcome^99DCT" required>
                                    <option value=""></option>
                                    <option value="165334^Returned to Care^99DCT">1 - Returned to care</option>
                                    <option value="165335^Self Transfered^99DCT"> 2 - Self transferred</option>
                                    <option value="1363^STOPPED^99DCT"> 3 - Stopped/Refused</option>
                                    <option value="165486^Patient migrated/relocated^99DCT"> 4 - Migrated/Relocated</option>
                                    <option value="160034^Died^99DCT"> 5 - Died</option>
                                    <option value="165368^CAN NOT BE TRACED^99DCT"> 6 - Unable to be traced</option>
                                    <option value="165369^Tracing Attempts initiated but incomplete^99DCT"> 7 - Tracing attempts initiated but incomplete</option>
                                    <option value="165370^No Attempt^99DCT"> 8 - No attempt to trace</option>
                                    <option value="165371^Misclassified as missed Appointment^99DCT"> 9 - Misclassified as Missed Appointment</option>
                                </select>
                            </div>
                            <div id="ART_details">
                                <div class="form-group freetext">
                                    <label for="obs.name_of_location_transferred_to">
                                        ART Clinic<span class="required"></span>
                                    </label>
                                    <input class="form-control" id="obs.name_of_location_transferred_to" name="obs.name_of_location_transferred_to" type="text" data-concept="90211^NAME OF LOCATION TRANSFERRED TO^99DCT">
                                </div>
                                <div class="form-group freetext">
                                    <label for="obs.art_number">ART Number</label>
                                    <input class="form-control" id="obs.art_number" name="obs.art_number" type="text" data-concept="99431^ART Number^99DCT">
                                </div>
                            </div>
                        </div>
                        <div class="form-group" id="returned_to_care_date">
                            <label for="obs.date_client_returned_date">Date Returned to Care</label>
                            <input class="form-control datepicker past-date" id="obs.date_client_returned_date" name="obs.date_client_returned_date" data-concept="165378^Date Client Returned^99DCT" type="text" readonly="readonly">
                        </div>
                        <div class="form-group" id="self_transfered_date">
                            <label for="obs.transfer_out_date_date">Date Self Transferred</label>
                            <input class="form-control datepicker past-date" id="obs.transfer_out_date_date" name="obs.transfer_out_date_date"  data-concept="99165^TRANSFER OUT DATE^99DCT" type="text" readonly="readonly">
                        </div>
                        <div class="form-group" id="cause_of_death">
                            <label for="obs.cause_of_death">CAUSE OF DEATH</label>
                            <select class="form-control" id="obs.cause_of_death" name="obs.cause_of_death" data-concept="5002^CAUSE OF DEATH^99DCT">
                                <option value=""></option>
                                <option value="58^TUBERCULOSIS^99DCT">1 - TB</option>
                                <option value="116030^Cancer^99DCT"> 2 - Cancer</option>
                                <option value="165374^Infectious Disease other than TB^99DCT"> 3 - Infectious disease other than TB</option>
                                <option value="165375^HIV Non-infectious Disease^99DCT"> 4 - HIV Non-infectious disease</option>
                                <option value="165376^Natural Causes^99DCT"> 5 - Natural causes</option>
                                <option value="165377^Non natural causes^99DCT"> 6 - Non natural causes</option>
                                <option value="90001^UNKNOWN^99DCT"> 7 - Unknown</option>
                            </select>
                        </div>
                        <div class="form-group freetext">
                            <label for="obs.clinical_impression_comment">Clinical impression comment </label>
                            <input type="text" class="form-control" name="obs.clinical_impression_comment" id="obs.clinical_impression_comment" data-concept="159395^Clinical impression comment^99DCT">
                        </div>
                    </div>
                    <div class="section">
                        <div class="form-group">
                            <input class="form-control" id="encounter.form_uuid" name="encounter.form_uuid" type="hidden" required="required"/>
                            <input class="form-control" id="encounter.provider_role_uuid" name="encounter.provider_role_uuid" type="hidden" value="240b26f9-dd88-4172-823d-4a8bfeb7841f"/>
                        </div>
                        <div class="form-group">
                            <label for="encounter.encounter_datetime">Encounter Date:<span class="required">*</span>
                            </label>
                            <input class="form-control nonFutureDate past-date" id="encounter.encounter_datetime"
                                   name="encounter.encounter_datetime" type="text" readonly="readonly"
                                   required="required"/>
                        </div>
                        <div class="form-group show_provider_id_text" style="display:none">
                            <label for="encounter.provider_id">Follow Up Person\'s System ID:<span class="required">*</span></label>
                            <input class="form-control checkDigit" id="encounter.provider_id" disabled name="encounter.provider_id"
                                   type="text" required="required"  placeholder="Provider Id">
                        </div>
                        <div class="form-group">
                            <label for="encounter.location_id">Encounter Location:<span class="required">*</span></label>
                            <input class="form-control valid-location-only" id="encounter.location_id" type="text" placeholder="Start typing something..." required="required"/>
                            <input class="form-control" name="encounter.location_id" type="hidden"/>
                        </div>
                    </div>
                </form>
            </body>
            <script type="text/javascript">
                $(document).ready(function () {
                $("#save_draft").click(function () {
                $(this).prop("disabled", true)
                document.saveDraft()
                $(this).prop("disabled", false)
                })

                $("#submit_form").click(function () {
                $(this).prop("disabled", true)
                document.submit()
                $(this).prop("disabled", false)
                })

                var dateFormat = "dd-mm-yy"
                var currentDate = $.datepicker.formatDate(dateFormat, new Date())
                var encounterDatetime = $("#encounter\\\\.encounter_datetime")
                if ($(encounterDatetime).val() == "") {
                $(encounterDatetime).val(currentDate)
                }

                var followupDate = $("#obs\\\\.followup_date_date")
                if ($(followupDate).val() == "") {
                $(followupDate).val(currentDate)
                }

                $("#obs\\\\.service_point").change(function(){
                if($(this).val() == "90002^OTHER SPECIFY^99DCT"){
                $("#other_service_point_div").show()
                } else{
                $("#other_service_point_div").hide()
                }
                })
                $("#obs\\\\.service_point").trigger("change")

                $("#obs\\\\.medication_due_for_refill_other").change(function(){
                if($(this).prop( "checked" )){
                $("#medication_due_for_refill_other_div").show()
                } else{
                $("#medication_due_for_refill_other_div").hide()
                }
                })
                $("#obs\\\\.medication_due_for_refill_other").trigger("change")

                $("#obs\\\\.followup_method").change(function(){
                if($(this).val() == "90002^OTHER SPECIFY^99DCT"){
                $("#other_follow_up_action_div").show()
                } else{
                $("#other_follow_up_action_div").hide()
                }
                })
                $("#obs\\\\.followup_method").trigger("change")

                document.setupAutoCompleteData("encounter\\\\.location_id")
                document.setupAutoCompleteDataForProvider("encounter\\\\.provider_id_select")
                document.setupValidationForLocation("$(\'#encounter\\\\.location_id\').val()","encounter\\\\.location_id")
                document.setupValidationForProvider("$(\'#encounter\\\\.provider_id_select\').val()","encounter\\\\.provider_id")

                $("#obs\\\\.followup_date_date").change(function(){
                $("#encounter\\\\.encounter_datetime").val($("#obs\\\\.followup_date_date").val())
                })
                $("#obs\\\\.followup_date_date").trigger("change")

                var prePopulateData = $.trim($("#pre_populate_data").html())
                var prePopulateJSON = JSON.parse(prePopulateData)
                $.each(prePopulateJSON, function(key, value) {
                if (key === "patient") {
                var names = ""
                $.each(value, function(keys, values) {
                if(keys === "patient.given_name" || keys === "patient.middle_name" || keys === "patient.family_name"){
                names=names+" "+values
                }
                if(keys === "patient.birth_date"){
                var tmp = values.split("-")
                var birthDate = new Date(tmp[2],tmp[1]-1,tmp[0])
                var today = new Date()
                var milliSecondsInAYear = 1000 * 60 * 60 * 24 * 365.26
                var age = (today - birthDate) / milliSecondsInAYear
                $("#patient\\\\.age").val((Math.floor(age)+" Years "))
                }
                })
                $("#patient\\\\.names").val(names)
                }
                })

                var patientuuid = $("#patient\\\\.uuid").val()
                var lastAppointmentDate = htmlDataStore.getObsByConceptId(patientuuid,5096)
                lastAppointmentDate = JSON.parse(lastAppointmentDate)
                var lastAppointmentDateSize = lastAppointmentDate.length-1
                if(parseInt(lastAppointmentDateSize)>-1){
                if(lastAppointmentDate[0].valueDatetime!=""){
                var appointmentDate = lastAppointmentDate[0].valueDatetime
                }else{
                var appointmentDate = lastAppointmentDate[0].valueText
                }
                $("#obs\\\\.missed_appointment_date").val(appointmentDate)
                }

                var followupOutcome = $("#obs\\\\.followup_outcome")
                followupOutcome.change(function () {
                if ($("#obs\\\\.followup_outcome").val() == "165335^Self Transfered^99DCT") {
                $("#ART_details").show()
                $("#self_transfered_date").hide()
                $("#returned_to_care_date").hide()
                $("#cause_of_death").hide()
                } else if($("#obs\\\\.followup_outcome").val() == "165334^Returned to Care^99DCT"){
                $("#ART_details").hide()
                $("#self_transfered_date").hide()
                $("#returned_to_care_date").show()
                $("#cause_of_death").hide()
                }	else if($("#obs\\\\.followup_outcome").val() == "165335^Self Transfered^99DCT"){
                $("#ART_details").hide()
                $("#self_transfered_date").show()
                $("#returned_to_care_date").hide()
                $("#cause_of_death").hide()
                }	else if($("#obs\\\\.followup_outcome").val() == "160034^Died^99DCT"){
                $("#ART_details").hide()
                $("#self_transfered_date").hide()
                $("#returned_to_care_date").hide()
                $("#cause_of_death").show()
                }	else {
                $("#ART_details").hide()
                $("#self_transfered_date").hide()
                $("#returned_to_care_date").hide()
                $("#cause_of_death").hide()
                }
                })
                followupOutcome.trigger("change")
                })
            </script>
        </html>' where uuid = 'e8805c90-8792-4f39-a37a-e5f3aee0d00d';
        ]]>
        </sql>
    </changeSet>

    <changeSet id="muzima-20201216094000" author="bmokaya" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM muzima_config where uuid = '0e1202f5-5233-4f6e-8c67-c3a6aec6658f'
            </sqlCheck>
        </preConditions>
        <comment>Update setup config for patient tracing</comment>
        <sql>
            update muzima_config set config_json='{"config":{"settings":[{"datatype":"BOOLEAN","name":"Relationships status","property":"Relationships.isEnabled","description":"Specifies if Relationships feature will be enabled for this implementation","uuid":"f8c4ea54-9e8f-4f47-86c1-ab52f0bc719f","value":true},{"datatype":"STRING","name":"Maximum number of Encounters downloaded per patient","property":"Encounter.maxDownloadSize","description":"Specifies the maximum number of encounters to be downloaded into mUzima per patient","uuid":"eb780e26-30a0-4e53-b3da-a3f56f13ccde","value":"1"},{"datatype":"STRING","name":"Maximum number of observations downloaded per patient for a given concept","property":"Obs.maximumDownloadSize","description":"Specifies the maximum number of observations to be downloaded into mUzima app per patient for each concept","uuid":"134bc6be-24c4-11eb-940f-d0577bb73cd4","value":"1"}],"concepts":[{"name":"VIRAL LOAD QUALITATIVE","uuid":"dca12261-30ab-102d-86b0-7a5022ba4115"},{"name":"HIV VIRAL LOAD","uuid":"dc8d83e3-30ab-102d-86b0-7a5022ba4115"},{"name":"RETURN VISIT DATE","uuid":"dcac04cf-30ab-102d-86b0-7a5022ba4115"},{"name":"Differentiated Service Delivery","uuid":"73312fee-c321-11e8-a355-529269fb1459"},{"name":"CURRENT ARV REGIMEN","uuid":"dd2b0b4d-30ab-102d-86b0-7a5022ba4115"},{"name":"WHO HIV CLINICAL STAGE","uuid":"dcdff274-30ab-102d-86b0-7a5022ba4115"}],"name":"Patient Tracing","description":"Patient Tracing Config","locations":[{"name":"Community","uuid":"841cb8d9-b662-41ad-9e7f-d476caac48aa"}],"forms":[{"name":"HMIS ACP 007 Missed Appointment Tracking Form","uuid":"e8805c90-8792-4f39-a37a-e5f3aee0d00d"}],"providers":[],"cohorts":[{"isFilterByProviderEnabled":false,"isFilterByLocationEnabled":false,"name":"Missed Appointment","description":"Missed Appointment","uuid":"a857790c-2d56-11eb-8daf-d0577bb73cd4"},{"isFilterByProviderEnabled":false,"isFilterByLocationEnabled":false,"name":"Lost to Follow up","description":"Lost to Follow up","uuid":"aefab9d4-2d4e-11eb-8daf-d0577bb73cd4"}]}}' where uuid='0e1202f5-5233-4f6e-8c67-c3a6aec6658f';
        </sql>
    </changeSet>

    <changeSet id="muzima-20201216153000" author="bmokaya" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM scheduler_task_config where schedulable_class =
                'org.openmrs.module.muzima.task.ProcessExpandedCohortTask'
            </sqlCheck>
        </preConditions>
        <comment>Update ProcessExpandedCohortTask</comment>
        <sql>
            update scheduler_task_config set repeat_interval=60 where schedulable_class = 'org.openmrs.module.muzima.task.ProcessExpandedCohortTask';
        </sql>
    </changeSet>

    <changeSet id="muzima-20210728165000" author="bmokaya" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM expanded_cohort_definition where uuid = 'd147624e-2d58-11eb-8daf-d0577bb73cd4'
            </sqlCheck>
        </preConditions>
        <comment>Update expanded cohort definition</comment>
        <sql>
            update expanded_cohort_definition set sql_definition="select person_id from (select o.person_id, max(o.value_datetime) maxApp,DATEDIFF(now(),max(o.value_datetime)) datedif from obs o left join person p on p.person_id=o.person_id
            where o.concept_id=5096 and p.voided='false' group by o.person_id having datedif between 31 and 90) t" where uuid = 'd147624e-2d58-11eb-8daf-d0577bb73cd4'
        </sql>
    </changeSet>

    <changeSet id="muzima-20210728165200" author="bmokaya" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM expanded_cohort_definition where uuid = '9404d22e-08c8-4bc0-bfdf-f027285f6b21'
            </sqlCheck>
        </preConditions>
        <comment>Update expanded cohort definition</comment>
        <sql>
            update expanded_cohort_definition set sql_definition="select person_id from (select o.person_id,max(o.value_datetime)
            maxApp,DATEDIFF(now(),max(o.value_datetime)) datedif from obs o left join person p on p.person_id=o.person_id
            where o.concept_id=5096 and p.voided='false' group by o.person_id having datedif between 7 and 30) t" where uuid = '9404d22e-08c8-4bc0-bfdf-f027285f6b21';
        </sql>
    </changeSet>

    <changeSet id="muzima-20210728165700" author="bmokaya">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM cohort where uuid = '79af2cb6-efad-11eb-a534-d0577bb73cd4';
            </sqlCheck>
        </preConditions>
        <comment>Add Missed Appointment Cohort 0 t0 7 days</comment>
        <insert tableName="cohort">
            <column name="name" value="Same day follow-up"/>
            <column name="description" value="List of patients who have a missed appointment between 0 and 7 days"/>
            <column name="date_created" valueDate="2021-07-28T16:57:00" />
            <column name="creator" value="1" />
            <column name="voided" value="0" />
            <column name="uuid" value="79af2cb6-efad-11eb-a534-d0577bb73cd4" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20210728170200" author="bmokaya" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM expanded_cohort_definition where uuid = '78338a16-f12f-11eb-a534-d0577bb73cd4'
            </sqlCheck>
        </preConditions>
        <comment>Add item into expanded cohort definition</comment>
        <sql>
            INSERT INTO expanded_cohort_definition (cohort_id, sql_definition, is_scheduled, creator, date_created, changed_by,
            date_changed, voided, voided_by, date_voided, void_reason, uuid,enable_member_addition,enable_member_removal) VALUES ((select cohort_id from cohort where uuid='79af2cb6-efad-11eb-a534-d0577bb73cd4') ,"select person_id from (select o.person_id, max(o.value_datetime) maxApp,DATEDIFF(now(),max(o.value_datetime)) datedif from obs o left join person p on p.person_id=o.person_id
            where o.concept_id=5096 and p.voided='false' group by o.person_id having datedif between 1 and 6) t",
            1, 1, now(), NULL, NULL, 0, NULL, NULL, NULL, '78338a16-f12f-11eb-a534-d0577bb73cd4',1,1);
        </sql>
    </changeSet>

    <changeSet id="muzima-20210730111800" author="bmokaya">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM cohort where uuid = 'abf6a336-f10e-11eb-a534-d0577bb73cd4';
            </sqlCheck>
        </preConditions>
        <comment>Add Cohort for successful followups</comment>
        <insert tableName="cohort">
            <column name="name" value="Successful follow-ups"/>
            <column name="description" value="List of patients who have been followed up successfully"/>
            <column name="date_created" valueDate="2021-07-30T11:18:00" />
            <column name="creator" value="1" />
            <column name="voided" value="0" />
            <column name="uuid" value="abf6a336-f10e-11eb-a534-d0577bb73cd4" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20210730161800" author="bmokaya" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM muzima_config where uuid = '0e1202f5-5233-4f6e-8c67-c3a6aec6658f'
            </sqlCheck>
        </preConditions>
        <comment>Update setup config for patient tracing</comment>
        <sql>
            update muzima_config set config_json='{"config":{"settings":[{"datatype":"BOOLEAN","name":"Relationships status","property":"Relationships.isEnabled","description":"Specifies if Relationships feature will be enabled for this implementation","uuid":"f8c4ea54-9e8f-4f47-86c1-ab52f0bc719f","value":true},{"datatype":"STRING","name":"Maximum number of Encounters downloaded per patient","property":"Encounter.maxDownloadSize","description":"Specifies the maximum number of encounters to be downloaded into mUzima per patient","uuid":"eb780e26-30a0-4e53-b3da-a3f56f13ccde","value":"1"},{"datatype":"STRING","name":"Maximum number of observations downloaded per patient for a given concept","property":"Obs.maximumDownloadSize","description":"Specifies the maximum number of observations to be downloaded into mUzima app per patient for each concept","uuid":"134bc6be-24c4-11eb-940f-d0577bb73cd4","value":"1"}],"concepts":[{"name":"ADDRESS","uuid":"dce122f3-30ab-102d-86b0-7a5022ba4115"},{"name":"VIRAL LOAD QUALITATIVE","uuid":"dca12261-30ab-102d-86b0-7a5022ba4115"},{"name":"HIV VIRAL LOAD","uuid":"dc8d83e3-30ab-102d-86b0-7a5022ba4115"},{"name":"RETURN VISIT DATE","uuid":"dcac04cf-30ab-102d-86b0-7a5022ba4115"},{"name":"Differentiated Service Delivery","uuid":"73312fee-c321-11e8-a355-529269fb1459"},{"name":"CURRENT ARV REGIMEN","uuid":"dd2b0b4d-30ab-102d-86b0-7a5022ba4115"},{"name":"WHO HIV CLINICAL STAGE","uuid":"dcdff274-30ab-102d-86b0-7a5022ba4115"}],"name":"Patient Tracing","description":"Patient Tracing Config","locations":[{"name":"Community","uuid":"841cb8d9-b662-41ad-9e7f-d476caac48aa"}],"forms":[{"name":"HMIS ACP 007 Missed Appointment Tracking Form","uuid":"e8805c90-8792-4f39-a37a-e5f3aee0d00d"}],"providers":[],"cohorts":[{"isFilterByProviderEnabled":false,"isFilterByLocationEnabled":false,"name":"Missed Appointment","description":"Missed Appointment","uuid":"a857790c-2d56-11eb-8daf-d0577bb73cd4"},{"isFilterByProviderEnabled":false,"isFilterByLocationEnabled":false,"name":"Lost to Follow up","description":"Lost to Follow up","uuid":"aefab9d4-2d4e-11eb-8daf-d0577bb73cd4"},{"isFilterByProviderEnabled":false,"isFilterByLocationEnabled":false,"name":"Same day follow-up","description":"List of patients who have a missed appointment between 0 and 7 days","uuid":"79af2cb6-efad-11eb-a534-d0577bb73cd4"},{"isFilterByProviderEnabled":false,"isFilterByLocationEnabled":false,"name":"Successful follow-ups","description":"List of patients who have been followed up successfully","uuid":"abf6a336-f10e-11eb-a534-d0577bb73cd4"}]}}' where uuid='0e1202f5-5233-4f6e-8c67-c3a6aec6658f';
        </sql>
    </changeSet>

    <changeSet id="muzima-20210730163700" author="bmokaya">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM muzima_form where uuid = 'e8805c90-8792-4f39-a37a-e5f3aee0d00d'
            </sqlCheck>
        </preConditions>
        <comment>update tracking form</comment>
        <sql>
            <![CDATA[
            update muzima_form set form_html='<html xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
<head>
    <link href="css/bootstrap.min.css" rel="stylesheet"/>
    <link href="css/muzima.css" rel="stylesheet"/>
    <link href="css/ui-darkness/jquery-ui-1.10.4.custom.min.css" rel="stylesheet"/>

    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-ui-1.10.4.custom.min.js"></script>
    <script src="js/jquery.validate.min.js"></script>
    <script src="js/additional-methods.min.js"></script>
    <script src="js/muzima.js"></script>
    <title>Missed Appointment Tracking Register</title>
</head>
<body class="col-md-10 col-md-offset-1">
<div id="pre_populate_data">

</div>
<form id="missed_appointment_tracking_register" name="missed_appointment_tracking_register">
    <h2 class="text-center">Missed Appointment Tracking Register</h2>
    <div class="section">
        <h3>Demographics</h3>
        <div class="form-group">
            <input class="form-control" id="patient.uuid"
                   name="patient.uuid" type="hidden" readonly="readonly">
        </div>

        <div class="form-group">
            <label for="patient.medical_record_number">Medical No:</label>
            <input class="form-control" id="patient.medical_record_number"
                   name="patient.medical_record_number" type="text"
                   readonly="readonly">
        </div>
        <div class="form-group" style="display:none">
            <label for="patient.family_name">Family Name:</label>
            <input class="form-control" id="patient.family_name"
                   name="patient.family_name" type="text" readonly="readonly">
        </div>
        <div class="form-group" style="display:none">
            <label for="patient.given_name">Given Name:</label>
            <input class="form-control" id="patient.given_name"
                   name="patient.given_name" type="text" readonly="readonly">
        </div>
        <div class="form-group" style="display:none">
            <label for="patient.middle_name">Middle Name:</label>
            <input class="form-control" id="patient.middle_name"
                   name="patient.middle_name" type="text" readonly="readonly">
        </div>
		<div class="form-group">
            <label for="patient.middle_name">Name:</label>
            <input class="form-control" id="patient.names"
                   name="patient.names" type="text" readonly="readonly">
        </div>
        <div class="form-group">
            <label for="patient.sex">Gender:</label>
            <select class="form-control" id="patient.sex" name="patient.sex" readonly="readonly" disabled>
                <option value="">...</option>
                <option value="M">Male</option>
                <option value="F">Female</option>
            </select>
        </div>
        <div class="form-group">
            <label for="patient.birth_date">Date of birth:</label>
            <input class="form-control" id="patient.birth_date"
                   name="patient.birth_date" type="text" readonly="readonly">
        </div>
    </div>
	<div class="section">
        <h3>Locator Information</h3>
		 <div class="form-group">
            <label for="tmp.home_address_direction">Directions to home address:<span class="required"></span>
            </label>
            <input class="form-control" id="tmp.home_address_direction" name="tmp.home_address_direction" type="text" readonly="readonly"/>
        </div>
		<div class="form-group">
            <label for="patient.phone_number1">Phone No. 1:<span class="required"></span>
            </label>
            <input class="form-control" id="patient.phone_number1" name="patient.phone_number1" type="text" readonly="readonly"/>
        </div>
		<div class="form-group">
            <label for="patient.phone_number2">Phone No. 2:<span class="required"></span>
            </label>
            <input class="form-control" id="patient.phone_number2" name="patient.phone_number2" type="text" readonly="readonly"/>
        </div>
		<div class="form-group">
            <label for="patient.phone_number3">Phone No. 3:<span class="required"></span>
            </label>
            <input class="form-control" id="patient.phone_number3" name="patient.phone_number3" type="text" readonly="readonly"/>
        </div>
		<div class="form-group">
            <label for="patient.caregiver_name">Care Giver:<span class="required"></span>
            </label>
            <input class="form-control" id="patient.caregiver_name" name="patient.caregiver_name" type="text" readonly="readonly"/>
        </div>
		<div class="form-group">
            <label for="patient.caregiver_phone_number">Care Giver Tel No:<span class="required"></span>
            </label>
            <input class="form-control" id="patient.caregiver_phone_number" name="patient.caregiver_phone_number" type="text" readonly="readonly"/>
        </div>
	</div>
    <div class="section">
        <h3>Appointment Information</h3>
        <div class="form-group">
            <label for="obs.missed_appointment_date">Missed Appointment Date:<span class="required"></span>
            </label>
            <input class="form-control" data-concept="166158^Missed Appointment Date^99DCT"  id="obs.missed_appointment_date" name="obs.missed_appointment_date" type="text" readonly="readonly"/>
        </div>
		<div class="form-group service_point">
			<label for="obs.service_point">
			Service Point<span class="required"></span>
			</label>
			<select class="form-control" id="obs.service_point" name="obs.service_point" data-concept="164993^POINT OF CARE^99DCT">
				<option value="">...</option>
				<option value="165047^Antiretraviral Treatment Clinic^99DCT">ART Clinic</option>
				<option value="165048^Tuberculosis Clinic^99DCT">TB Clinic</option>
				<option value="90002^OTHER SPECIFY^99DCT">Other</option>
			</select>
        </div>
		<div class="form-group" id="other_service_point_div">
			<div class="form-group">
				<label for="obs.other_service_point">
					Other Service Point
				<span class="required"></span>
				</label>
				<div class="form-group">
					<input type="text" class="form-control" data-concept="165398^Other Point of Care^99DCT" name="obs.other_service_point" id="obs.other_service_point">
				</div>
			</div>
		</div>
		<div class="form-group">
			<label for="obs.medication_due_for_refill">
				 Medication Due for Refill
			<span class="required"></span>
			</label>
			<div class="form-group">
				<label for="obs.medication_due_for_refill_art" style="font-weight: normal;">
					<input type="checkbox" data-concept="165482^Medication due for refill^99DCT" value="164972^ART Refill^99DCT" name="obs.medication_due_for_refill" id="obs.medication_due_for_refill_art">&nbsp;ART
				</label>
			</div>
			<div class="form-group">
				<label for="obs.medication_due_for_refill_tb" style="font-weight: normal;">
					<input type="checkbox" data-concept="165482^Medication due for refill^99DCT" value="1159^TUBERCULOSIS TREATMENT DRUGS^99DCT" name="obs.medication_due_for_refill" id="obs.medication_due_for_refill_tb">&nbsp;TB Meds/TPT
				</label>
			</div>
			<div class="form-group">
				<label for="obs.medication_due_for_refill_inc" style="font-weight: normal;">
					<input type="checkbox" data-concept="165482^Medication due for refill^99DCT" value="1158^TUBERCULOSIS PROPHYLACTIC DRUGS^99DCT" name="obs.medication_due_for_refill" id="obs.medication_due_for_refill_inc">&nbsp;Infant NVP/CTX
				</label>
			</div>
			<div class="form-group">
				<label for="obs.medication_due_for_refill_fp" style="font-weight: normal;">
					<input type="checkbox" data-concept="165482^Medication due for refill^99DCT" value="5287^FAMILY PLANNING^99DCT" name="obs.medication_due_for_refill" id="obs.medication_due_for_refill_fp">&nbsp;FP
				</label>
			</div>
			<div class="form-group">
				<label for="obs.medication_due_for_refill_other" style="font-weight: normal;">
					<input type="checkbox" data-concept="165482^Medication due for refill^99DCT" value="5622^Other^99DCT" name="obs.medication_due_for_refill" id="obs.medication_due_for_refill_other">&nbsp;Other
				</label>
			</div>
            <div class="form-group" id="medication_due_for_refill_other_div">
				<label for="obs.medication_due_for_refill_specify">
					Other Specify:
				<span class="required"></span>
				</label>
				<input type="text" class="form-control" data-concept="165483^Other medication due for refill at appointment^99DCT" name="obs.medication_other_specify">
			</div>
		</div>
		<div class="form-group">
			<label for="obs.mode_of_care">
			Mode of Care<span class="required"></span>
			</label>
			<select class="form-control" id="obs.mode_of_care" name="obs.mode_of_care" data-concept="165143^Differentiated Service Delivery^99DCT">
				<option value="">...</option>
				<option value="165138^Facility Based Individual Management^99DCT">1 - FBIM</option>
				<option value="165140^Facility Based Groups^99DCT">2 - FBG</option>
				<option value="165139^Fast Track Drug Refill^99DCT">3 - FTDR</option>
				<option value="165142^Community Drug Distribution Point^99DCT">4 - CDDP</option>
				<option value="165141^Community Client Led ART Delivery^99DCT">5 - CCLAD</option>
			</select>
        </div>
	</div>
	<div class="section">
	    <h3>Tracking Information</h3>
        <div class="section group-set concept-set" data-concept="165346^General Follow Up^99DCT" >
			<div class="form-group">
				<label for="obs.follow_up_attemp">
				Follow Up Attempt<span class="required">*</span>
				</label>
				<select class="form-control" id="obs.follow_up_attemp" required name="obs.follow_up_attemp" data-concept="166157^Follow Up Attempts^99DCT">
					<option value="">...</option>
					<option value="165338^General Follow Up First Attempt^99DCT">1 - Follow Up 1</option>
					<option value="165339^General Follow Up Second Attempt^99DCT">2 - Follow Up 2</option>
					<option value="165340^General Follow Up Third Attempt^99DCT">3 - Follow Up 3</option>
					<option value="165341^General Follow Up Fourth Attempt^99DCT">4 - Follow Up 4</option>
					<option value="165342^General Follow Up Fifth Attempt^99DCT">5 - Follow Up 5</option>
					<option value="165343^General Follow Up Sixth Attempt^99DCT">6 - Follow Up 6</option>
				</select>
			</div>
			<div class="form-group">
				<label for="obs.followup_date_date">
					Followup Date<span class="required">*</span>
				</label>
				<input class="form-control datepicker past-date"  data-concept="165373^Followup Date^99DCT" id="obs.followup_date_date" name="obs.followup_date_date" type="text" readonly="readonly" required>
			</div>
			<div class="form-group">
				<label for="encounter.provider_id_select">
					Follow Up Person:<span class="required">*</span>
				</label>
				<input class="form-control valid-provider-only" id="encounter.provider_id_select"
				type="text" placeholder="Start typing something...">
				<input class="form-control" name="encounter.provider_id_select" type="hidden">
			</div>
			<div class="form-group">
					<label for="obs.followup_method">
						Followup Action<span class="required">*</span>
					</label>
					<select class="form-control" id="obs.followup_method" name="obs.followup_method" data-concept="165100^Followup Method^99DCT" required>
						<option value=""></option>
						<option value="165102^Phonecall^99DCT">Phone call to client/caregiver/next of Kin</option>
						<option value="165103^Home visit^99DCT"> Home/workplace visit by HCW</option>
						<option value="165336^Facility to Facility Phone Call^99DCT"> Facility to facility phone call</option>
						<option value="165337^Facility to Facility Visit^99DCT"> Facility to facility visit</option>
						<option value="90002^OTHER SPECIFY^99DCT"> Other</option>
					</select>
			</div>
			<div class="form-group freetext" id="other_follow_up_action_div">
				<label for="obs.other_follow_up_action/method">
					Other Follow up actions<span class="required">*</span>
				</label>
				<input class="form-control" id="obs.other_follow_up_action_method" name="obs.other_follow_up_action_method" type="text" data-concept="165481^Other follow up action/method^99DCT" required>
			</div>
			<div class="form-group">
				<label for="obs.followup_outcome">
					Follow Up Outcome<span class="required">*</span>
				</label>
				<select class="form-control" id="obs.followup_outcome" name="obs.followup_outcome" data-concept="165104^Followup Outcome^99DCT" required>
					<option value=""></option>
					<option value="165334^Returned to Care^99DCT">1 - Returned to care</option>
					<option value="165335^Self Transfered^99DCT"> 2 - Self transferred</option>
					<option value="1363^STOPPED^99DCT"> 3 - Stopped/Refused</option>
					<option value="165486^Patient migrated/relocated^99DCT"> 4 - Migrated/Relocated</option>
					<option value="160034^Died^99DCT"> 5 - Died</option>
					<option value="165368^CAN NOT BE TRACED^99DCT"> 6 - Unable to be traced</option>
					<option value="165369^Tracing Attempts initiated but incomplete^99DCT"> 7 - Tracing attempts initiated but incomplete</option>
					<option value="165370^No Attempt^99DCT"> 8 - No attempt to trace</option>
					<option value="165371^Misclassified as missed Appointment^99DCT"> 9 - Misclassified as Missed Appointment</option>
				</select>
			</div>
			<div id="ART_details">
				<div class="form-group freetext">
					<label for="obs.name_of_location_transferred_to">
						ART Clinic<span class="required"></span>
					</label>
					<input class="form-control" id="obs.name_of_location_transferred_to" name="obs.name_of_location_transferred_to" type="text" data-concept="90211^NAME OF LOCATION TRANSFERRED TO^99DCT">
				</div>
				<div class="form-group freetext">
					<label for="obs.art_number">ART Number</label>
					<input class="form-control" id="obs.art_number" name="obs.art_number" type="text" data-concept="99431^ART Number^99DCT">
				</div>
			</div>
		</div>
		<div class="form-group">
			<label for="obs.followup_outcome_by_end_of_current_quarter">Followup outcome by end of current quarter</label>
			<select class="form-control" id="obs.followup_outcome_by_end_of_current_quarter" name="obs.followup_outcome_by_end_of_current_quarter" data-concept="165484^Followup outcome by end of current quarter^99DCT">
				<option value=""></option>
				<option value="165334^Returned to Care^99DCT">1 - Returned to care</option>
				<option value="165335^Self Transfered^99DCT"> 2 - Self transferred</option>
				<option value="1363^STOPPED^99DCT"> 3 - Stopped/Refused</option>
				<option value="165486^Patient migrated/relocated^99DCT"> 4 - Migrated/Relocated</option>
				<option value="160034^Died^99DCT"> 5 - Died</option>
				<option value="165368^CAN NOT BE TRACED^99DCT"> 6 - Unable to be traced</option>
				<option value="165369^Tracing Attempts initiated but incomplete^99DCT"> 7 - Tracing attempts initiated but incomplete</option>
				<option value="165370^No Attempt^99DCT"> 8 - No attempt to trace</option>
				<option value="165371^Misclassified as missed Appointment^99DCT"> 9 - Misclassified as Missed Appointment</option>
			</select>
		</div>
		<div class="form-group">
				<label for="obs.followup_outcome_by_end_of_next_quarter">Followup outcome by end of next quarter</label>
				<select class="form-control" id="obs.followup_outcome_by_end_of_next_quarter" name="obs.followup_outcome_by_end_of_next_quarter" data-concept="165485^Followup outcome by end of next quarter^99DCT">
					<option value="" selected="true"></option>
					<option value="165334^Returned to Care^99DCT">1 - Returned to care</option>
					<option value="165335^Self Transfered^99DCT"> 2 - Self transferred</option>
					<option value="1363^STOPPED^99DCT"> 3 - Stopped/Refused</option>
					<option value="165486^Patient migrated/relocated^99DCT"> 4 - Migrated/Relocated</option>
					<option value="160034^Died^99DCT"> 5 - Died</option>
					<option value="165368^CAN NOT BE TRACED^99DCT"> 6 - Unable to be traced</option>
					<option value="165369^Tracing Attempts initiated but incomplete^99DCT"> 7 - Tracing attempts initiated but incomplete</option>
					<option value="165370^No Attempt^99DCT"> 8 - No attempt to trace</option>
					<option value="165371^Misclassified as missed Appointment^99DCT"> 9 - Misclassified as Missed Appointment</option>
				</select>
		</div>
		<div class="form-group" id="returned_to_care_date">
			<label for="obs.date_client_returned_date">Date Returned to Care</label>
			<input class="form-control datepicker past-date" id="obs.date_client_returned_date" name="obs.date_client_returned_date" data-concept="165378^Date Client Returned^99DCT" type="text" readonly="readonly">
		</div>
		<div class="form-group" id="self_transfered_date">
			<label for="obs.transfer_out_date_date">Date Self Transferred</label>
			<input class="form-control datepicker past-date" id="obs.transfer_out_date_date" name="obs.transfer_out_date_date"  data-concept="99165^TRANSFER OUT DATE^99DCT" type="text" readonly="readonly">
		</div>
		<div class="form-group" id="cause_of_death">
			<label for="obs.cause_of_death">CAUSE OF DEATH</label>
			<select class="form-control" id="obs.cause_of_death" name="obs.cause_of_death" data-concept="5002^CAUSE OF DEATH^99DCT">
				<option value=""></option>
				<option value="58^TUBERCULOSIS^99DCT">1 - TB</option>
				<option value="116030^Cancer^99DCT"> 2 - Cancer</option>
				<option value="165374^Infectious Disease other than TB^99DCT"> 3 - Infectious disease other than TB</option>
				<option value="165375^HIV Non-infectious Disease^99DCT"> 4 - HIV Non-infectious disease</option>
				<option value="165376^Natural Causes^99DCT"> 5 - Natural causes</option>
				<option value="165377^Non natural causes^99DCT"> 6 - Non natural causes</option>
				<option value="90001^UNKNOWN^99DCT"> 7 - Unknown</option>
			</select>
		</div>
		<div class="form-group freetext">
			<label for="obs.clinical_impression_comment">Clinical impression comment </label>
			<input type="text" class="form-control" name="obs.clinical_impression_comment" id="obs.clinical_impression_comment" data-concept="159395^Clinical impression comment^99DCT">
		</div>
	</div>
	 <div class="section">
        <div class="form-group">
            <input class="form-control" id="encounter.form_uuid" name="encounter.form_uuid" type="hidden" required="required"/>
            <input class="form-control" id="encounter.provider_role_uuid" name="encounter.provider_role_uuid" type="hidden" value="240b26f9-dd88-4172-823d-4a8bfeb7841f"/>
		</div>
		<div class="form-group">
            <label for="encounter.encounter_datetime">Encounter Date:<span class="required">*</span>
            </label>
            <input class="form-control nonFutureDate past-date" id="encounter.encounter_datetime"
                   name="encounter.encounter_datetime" type="text" readonly="readonly"
                   required="required"/>
        </div>
		<div class="form-group show_provider_id_text" style="display:none">
			<label for="encounter.provider_id">Follow Up Person\'s System ID:<span class="required">*</span></label>
			<input class="form-control checkDigit" id="encounter.provider_id" disabled name="encounter.provider_id"
			   type="text" required="required"  placeholder="Provider Id">
		</div>
		<div class="form-group">
            <label for="encounter.location_id">Encounter Location:<span class="required">*</span></label>
            <input class="form-control valid-location-only" id="encounter.location_id" type="text" placeholder="Start typing something..." required="required"/>
            <input class="form-control" name="encounter.location_id" type="hidden"/>
        </div>
    </div>
</form>
</body>
<script type="text/javascript">
$(document).ready(function () {
	$("#save_draft").click(function () {
		$(this).prop("disabled", true)
		document.saveDraft()
		$(this).prop("disabled", false)
	})

	$("#submit_form").click(function () {
		$(this).prop("disabled", true)
		document.submit()
		$(this).prop("disabled", false)
	})

	var dateFormat = "dd-mm-yy"
	var currentDate = $.datepicker.formatDate(dateFormat, new Date())
	var encounterDatetime = $("#encounter\\\\.encounter_datetime")
	if ($(encounterDatetime).val() == "") {
		$(encounterDatetime).val(currentDate)
	}

	var followupDate = $("#obs\\\\.followup_date_date")
	if ($(followupDate).val() == "") {
		$(followupDate).val(currentDate)
	}


	$("#obs\\\\.service_point").change(function(){
		if($(this).val() == "90002^OTHER SPECIFY^99DCT"){
			$("#other_service_point_div").show()
		} else{
			$("#other_service_point_div").hide()
		}
	})
	$("#obs\\\\.service_point").trigger("change")

	$("#obs\\\\.medication_due_for_refill_other").change(function(){
		if($(this).prop( "checked" )){
			$("#medication_due_for_refill_other_div").show()
		} else{
			$("#medication_due_for_refill_other_div").hide()
		}
	})
	$("#obs\\\\.medication_due_for_refill_other").trigger("change")

	$("#obs\\\\.followup_method").change(function(){
		if($(this).val() == "90002^OTHER SPECIFY^99DCT"){
			$("#other_follow_up_action_div").show()
		} else{
			$("#other_follow_up_action_div").hide()
		}
	})
	$("#obs\\\\.followup_method").trigger("change")

	// attach "nonFutureDate" class to perform validation.
	jQuery.validator.addClassRules({
		validDeliveryDateOnly: { validDeliveryDateOnly: true }
	})

	document.setupAutoCompleteData("encounter\\\\.location_id")
	document.setupAutoCompleteDataForProvider("encounter\\\\.provider_id_select")
	document.setupValidationForLocation($("#encounter\\\\.location_id").val(),"encounter\\\\.location_id")
	document.setupValidationForProvider($("#encounter\\\\.provider_id_select").val(),"encounter\\\\.provider_id")

	$("#obs\\\\.followup_date_date").change(function(){
		$("#encounter\\\\.encounter_datetime").val($("#obs\\\\.followup_date_date").val())
	})
	$("#obs\\\\.followup_date_date").trigger("change")

	var prePopulateData = $.trim($("#pre_populate_data").html())
	var prePopulateJSON = JSON.parse(prePopulateData)
	var index = 0
	var hivNumberAvailable = false
	$.each(prePopulateJSON, function(key, value) {
		if (key === "patient") {
			var names = ""
			$.each(value, function(keys, values) {
				if(keys === "patient.given_name" || keys === "patient.middle_name" || keys === "patient.family_name"){
				   names=names+" "+values
				}

				if(keys === "patient.birth_date"){
					var tmp = values.split("-")
                    var birthDate = new Date(tmp[2],tmp[1]-1,tmp[0])
					var today = new Date()
					var milliSecondsInAYear = 1000 * 60 * 60 * 24 * 365.26
					var age = (today - birthDate) / milliSecondsInAYear
					$("#patient\\\\.age").val((Math.floor(age)+" Years "))
				}

				if (keys === "patient.personattribute") {
					$.each(values, function (keyss, valuess) {
						if(valuess.attribute_type_uuid === "14d4f066-15f5-102d-96e4-000c29c2a5d7"){
							 $("#patient\\\\.phone_number1").val(valuess.attribute_value)
						}
						if(valuess.attribute_type_uuid === "8c44d411-285f-46c6-9f17-c2f919823b34"){
							 $("#patient\\\\.phone_number2").val(valuess.attribute_value)
						}
						if(valuess.attribute_type_uuid === "a00eda65-2f66-4fda-a683-c1787eb626a9"){
							 $("#patient\\\\.phone_number3").val(valuess.attribute_value)
						}
						if(valuess.attribute_type_uuid === "e493f4ec-51f1-4a77-8d3c-5791f8cb02cd"){
							 $("#patient\\\\.caregiver_name").val(valuess.attribute_value)
						}
						if(valuess.attribute_type_uuid === "553834ef-b3fe-4c79-826a-6d4b6978bcff"){
							 $("#patient\\\\.caregiver_phone_number").val(valuess.attribute_value)
						}
					})
				}
			})
			$("#patient\\\\.names").val(names)
		}

		if (key === "other_identifier_type") {
			var arraySize = value.length
			var i = 0
			while(i < arraySize){
				if(value[i] === "HIV Clinic No."){
					hivNumberAvailable = true
					index = i
				}
				i++
			}
		}

		if(key === "other_identifier_value"){
			if(hivNumberAvailable){
				$("#patient\\\\.medical_record_number").val(value[index])
			}
		}


	})

   var patientuuid = $("#patient\\\\.uuid").val()
   var lastAppointmentDate = htmlDataStore.getObsByConceptId(patientuuid,5096)
   lastAppointmentDate = JSON.parse(lastAppointmentDate)
   var lastAppointmentDateSize = lastAppointmentDate.length-1
   if(parseInt(lastAppointmentDateSize)>-1){
			if(lastAppointmentDate[0].valueDatetime!=""){
				var appointmentDate = lastAppointmentDate[0].valueDatetime
			 }else{
				var appointmentDate = lastAppointmentDate[0].valueText
			 }
			$("#obs\\\\.missed_appointment_date").val(appointmentDate)
	}

	var homeAddressLocation = htmlDataStore.getObsByConceptId(patientuuid,90265)
   homeAddressLocation = JSON.parse(homeAddressLocation)
   var homeAddressLocationSize = homeAddressLocation.length-1
   if(parseInt(homeAddressLocationSize)>-1){
			var homeAddress = homeAddressLocation[0].valueText
			$("#tmp\\\\.home_address_direction").val(homeAddress)
	}

	 var followupOutcome = $("#obs\\\\.followup_outcome")
        followupOutcome.change(function () {
            if ($("#obs\\\\.followup_outcome").val() == "165335^Self Transfered^99DCT") {
					$("#ART_details").show()
					$("#self_transfered_date").hide()
					$("#returned_to_care_date").hide()
					$("#cause_of_death").hide()
            } else if($("#obs\\\\.followup_outcome").val() == "165334^Returned to Care^99DCT"){
					$("#ART_details").hide()
					$("#self_transfered_date").hide()
					$("#returned_to_care_date").show()
					$("#cause_of_death").hide()
			}	else if($("#obs\\\\.followup_outcome").val() == "165335^Self Transfered^99DCT"){
					$("#ART_details").hide()
					$("#self_transfered_date").show()
					$("#returned_to_care_date").hide()
					$("#cause_of_death").hide()
			}	else if($("#obs\\\\.followup_outcome").val() == "160034^Died^99DCT"){
					$("#ART_details").hide()
					$("#self_transfered_date").hide()
					$("#returned_to_care_date").hide()
					$("#cause_of_death").show()
			}	else {
					$("#ART_details").hide()
					$("#self_transfered_date").hide()
					$("#returned_to_care_date").hide()
					$("#cause_of_death").hide()
            }
        })
        followupOutcome.trigger("change")

})
</script>
</html>' where uuid = 'e8805c90-8792-4f39-a37a-e5f3aee0d00d';
        ]]>
        </sql>
    </changeSet>
</databaseChangeLog>
